"use strict";var I=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var Q=Object.prototype.hasOwnProperty;var Y=(o,r)=>{for(var e in r)I(o,e,{get:r[e],enumerable:!0})},_=(o,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of X(r))!Q.call(o,i)&&i!==e&&I(o,i,{get:()=>r[i],enumerable:!(t=G(r,i))||t.enumerable});return o};var ee=o=>_(I({},"__esModule",{value:!0}),o);var le={};Y(le,{default:()=>P});module.exports=ee(le);var O=require("obsidian");var w=require("obsidian"),T=class extends w.PluginSettingTab{constructor(r,e){super(r,e),this.plugin=e}display(){let{containerEl:r}=this;r.empty(),r.createEl("h2",{text:"Diff Apply \u63D2\u4EF6\u8BBE\u7F6E"}),new w.Setting(r).setName("\u5B57\u4F53\u5927\u5C0F").setDesc("\u8BBE\u7F6E\u7F16\u8F91\u5668\u4E2D\u7684\u5B57\u4F53\u5927\u5C0F\uFF08\u50CF\u7D20\uFF09").addSlider(t=>t.setLimits(10,24,1).setValue(this.plugin.settings.fontSize).setDynamicTooltip().onChange(async i=>{this.plugin.settings.fontSize=i,await this.plugin.saveSettings()})),new w.Setting(r).setName("\u9ED8\u8BA4\u5DEE\u5F02\u89C6\u56FE\u4F4D\u7F6E").setDesc("\u8BBE\u7F6E\u6253\u5F00\u5DEE\u5F02\u89C6\u56FE\u65F6\u7684\u9ED8\u8BA4\u663E\u793A\u4F4D\u7F6E").addDropdown(t=>t.addOption("left","\u5DE6\u4FA7").addOption("center","\u4E2D\u95F4").addOption("right","\u53F3\u4FA7").setValue(this.plugin.settings.defaultDiffPosition).onChange(async i=>{this.plugin.settings.defaultDiffPosition=i,await this.plugin.saveSettings()})),new w.Setting(r).setName("\u53CC\u51FB\u884C\u590D\u5236\uFF1A\u667A\u80FD\u8865\u6362\u884C").setDesc("Read Only \u4E0B\u53CC\u51FB\u590D\u5236\u884C\u5230 Editor \u65F6\uFF1A\u5982\u679C\u6E90\u6587\u672C\u4E0A\u4E00\u884C\u4E3A\u7A7A\uFF08\u6216\u4EC5\u7A7A\u767D\uFF09\u5219\u5728\u63D2\u5165\u5185\u5BB9\u524D\u8865\u5230\u81F3\u5C11 2 \u4E2A\u6362\u884C\uFF1B\u5426\u5219\u8865\u5230\u81F3\u5C11 1 \u4E2A\u3002\u4EC5\u5728 Editor \u975E\u7A7A\u3001\u4E14\u5149\u6807\u4E0D\u5728\u884C\u5185\u65F6\u751F\u6548\u3002").addToggle(t=>t.setValue(this.plugin.settings.smartDblClickInsertNewlines).onChange(async i=>{this.plugin.settings.smartDblClickInsertNewlines=i,await this.plugin.saveSettings()})),r.createEl("h3",{text:"\u5FEB\u6377\u952E\u8BF4\u660E"});let e=r.createEl("ul");e.createEl("li",{text:"Cmd/Ctrl + , : \u5DEE\u5F02\u89C6\u56FE\u4F4D\u7F6E\u5DE6\u79FB"}),e.createEl("li",{text:"Cmd/Ctrl + . : \u5DEE\u5F02\u89C6\u56FE\u4F4D\u7F6E\u53F3\u79FB"}),e.createEl("li",{text:"Cmd/Ctrl + / : \u5207\u6362\u5DEE\u5F02\u89C6\u56FE\u663E\u793A/\u9690\u85CF"}),e.createEl("li",{text:"Enter : \u590D\u5236\u9009\u4E2D\u6587\u672C\u5230\u7F16\u8F91\u5668"}),e.createEl("li",{text:"\u53CC\u51FB\u53EA\u8BFB\u680F\u4EFB\u610F\u975E\u7A7A\u884C\uFF1A\u590D\u5236\u8BE5\u884C\u5230\u7F16\u8F91\u5668"}),e.createEl("li",{text:"Cmd/Ctrl + Z : \u64A4\u9500\u7F16\u8F91"})}};var v=require("obsidian");function g(){}g.prototype={diff:function(r,e){var t,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},n=i.callback;typeof i=="function"&&(n=i,i={}),this.options=i;var l=this;function s(p){return n?(setTimeout(function(){n(void 0,p)},0),!0):p}r=this.castInput(r),e=this.castInput(e),r=this.removeEmpty(this.tokenize(r)),e=this.removeEmpty(this.tokenize(e));var d=e.length,a=r.length,f=1,c=d+a;i.maxEditLength&&(c=Math.min(c,i.maxEditLength));var h=(t=i.timeout)!==null&&t!==void 0?t:1/0,u=Date.now()+h,y=[{oldPos:-1,lastComponent:void 0}],E=this.extractCommon(y[0],e,r,0);if(y[0].oldPos+1>=a&&E+1>=d)return s([{value:this.join(e),count:e.length}]);var b=-1/0,x=1/0;function R(){for(var p=Math.max(b,-f);p<=Math.min(x,f);p+=2){var m=void 0,S=y[p-1],D=y[p+1];S&&(y[p-1]=void 0);var H=!1;if(D){var k=D.oldPos-p;H=D&&0<=k&&k<d}var B=S&&S.oldPos+1<a;if(!H&&!B){y[p]=void 0;continue}if(!B||H&&S.oldPos+1<D.oldPos?m=l.addToPath(D,!0,void 0,0):m=l.addToPath(S,void 0,!0,1),E=l.extractCommon(m,e,r,p),m.oldPos+1>=a&&E+1>=d)return s(te(l,m.lastComponent,e,r,l.useLongestToken));y[p]=m,m.oldPos+1>=a&&(x=Math.min(x,p-1)),E+1>=d&&(b=Math.max(b,p+1))}f++}if(n)(function p(){setTimeout(function(){if(f>c||Date.now()>u)return n();R()||p()},0)})();else for(;f<=c&&Date.now()<=u;){var V=R();if(V)return V}},addToPath:function(r,e,t,i){var n=r.lastComponent;return n&&n.added===e&&n.removed===t?{oldPos:r.oldPos+i,lastComponent:{count:n.count+1,added:e,removed:t,previousComponent:n.previousComponent}}:{oldPos:r.oldPos+i,lastComponent:{count:1,added:e,removed:t,previousComponent:n}}},extractCommon:function(r,e,t,i){for(var n=e.length,l=t.length,s=r.oldPos,d=s-i,a=0;d+1<n&&s+1<l&&this.equals(e[d+1],t[s+1]);)d++,s++,a++;return a&&(r.lastComponent={count:a,previousComponent:r.lastComponent}),r.oldPos=s,d},equals:function(r,e){return this.options.comparator?this.options.comparator(r,e):r===e||this.options.ignoreCase&&r.toLowerCase()===e.toLowerCase()},removeEmpty:function(r){for(var e=[],t=0;t<r.length;t++)r[t]&&e.push(r[t]);return e},castInput:function(r){return r},tokenize:function(r){return r.split("")},join:function(r){return r.join("")}};function te(o,r,e,t,i){for(var n=[],l;r;)n.push(r),l=r.previousComponent,delete r.previousComponent,r=l;n.reverse();for(var s=0,d=n.length,a=0,f=0;s<d;s++){var c=n[s];if(c.removed){if(c.value=o.join(t.slice(f,f+c.count)),f+=c.count,s&&n[s-1].added){var u=n[s-1];n[s-1]=n[s],n[s]=u}}else{if(!c.added&&i){var h=e.slice(a,a+c.count);h=h.map(function(E,b){var x=t[f+b];return x.length>E.length?x:E}),c.value=o.join(h)}else c.value=o.join(e.slice(a,a+c.count));a+=c.count,c.added||(f+=c.count)}}var y=n[d-1];return d>1&&typeof y.value=="string"&&(y.added||y.removed)&&o.equals("",y.value)&&(n[d-2].value+=y.value,n.pop()),n}var ie=new g;function M(o,r,e){return ie.diff(o,r,e)}var K=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,W=/\S/,$=new g;$.equals=function(o,r){return this.options.ignoreCase&&(o=o.toLowerCase(),r=r.toLowerCase()),o===r||this.options.ignoreWhitespace&&!W.test(o)&&!W.test(r)};$.tokenize=function(o){for(var r=o.split(/([^\S\r\n]+|[()[\]{}'"\r\n]|\b)/),e=0;e<r.length-1;e++)!r[e+1]&&r[e+2]&&K.test(r[e])&&K.test(r[e+2])&&(r[e]+=r[e+2],r.splice(e+1,2),e--);return r};var q=new g;q.tokenize=function(o){this.options.stripTrailingCr&&(o=o.replace(/\r\n/g,`
`));var r=[],e=o.split(/(\n|\r\n)/);e[e.length-1]||e.pop();for(var t=0;t<e.length;t++){var i=e[t];t%2&&!this.options.newlineIsToken?r[r.length-1]+=i:(this.options.ignoreWhitespace&&(i=i.trim()),r.push(i))}return r};var ne=new g;ne.tokenize=function(o){return o.split(/(\S.+?[.!?])(?=\s+|$)/)};var re=new g;re.tokenize=function(o){return o.split(/([{}:;,]|\s+)/)};function C(o){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?C=function(r){return typeof r}:C=function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},C(o)}var oe=Object.prototype.toString,L=new g;L.useLongestToken=!0;L.tokenize=q.tokenize;L.castInput=function(o){var r=this.options,e=r.undefinedReplacement,t=r.stringifyReplacer,i=t===void 0?function(n,l){return typeof l=="undefined"?e:l}:t;return typeof o=="string"?o:JSON.stringify(A(o,null,null,i),i,"  ")};L.equals=function(o,r){return g.prototype.equals.call(L,o.replace(/,([\r\n])/g,"$1"),r.replace(/,([\r\n])/g,"$1"))};function A(o,r,e,t,i){r=r||[],e=e||[],t&&(o=t(i,o));var n;for(n=0;n<r.length;n+=1)if(r[n]===o)return e[n];var l;if(oe.call(o)==="[object Array]"){for(r.push(o),l=new Array(o.length),e.push(l),n=0;n<o.length;n+=1)l[n]=A(o[n],r,e,t,i);return r.pop(),e.pop(),l}if(o&&o.toJSON&&(o=o.toJSON()),C(o)==="object"&&o!==null){r.push(o),l={},e.push(l);var s=[],d;for(d in o)o.hasOwnProperty(d)&&s.push(d);for(s.sort(),n=0;n<s.length;n+=1)d=s[n],l[d]=A(o[d],r,e,t,d);r.pop(),e.pop()}else l=o;return l}var N=new g;N.tokenize=function(o){return o.slice()};N.join=N.removeEmpty=function(o){return o};function U(o,r){if(r<=0)return 1;let e=r-1,t=o.lastIndexOf(`
`,e-1)+1;return o.substring(t,e).trim().length===0?2:1}function j(o,r,e){if(e<=0||o.length===0||r<=0||r>o.length)return"";let t=o[r-1],i=o.indexOf(`
`,r);if(t!==`
`&&(i!==-1&&r<i||i===-1&&r<o.length))return"";let l=0;for(let d=r-1;d>=0&&o[d]===`
`;d-=1)l+=1;let s=Math.max(0,e-l);return`
`.repeat(s)}function J(o,r){let e={};return o.forEach((t,i)=>{if(i<r.length){let n=r[i];if(t===n){e[i]="unchanged";return}M(t,n).some(d=>d.added||d.removed)?n.trim()!==""?e[i]="modified":e[i]="removed":e[i]="unchanged";return}e[i]="removed"}),e}function Z(o,r){let e={};return r.forEach((t,i)=>{if(i<o.length){let n=o[i];if(t===n){e[i]="unchanged";return}if(n.trim()===""&&t.trim()!==""){e[i]="added";return}M(n,t).some(d=>d.added||d.removed)&&n.trim()===""?e[i]="added":e[i]="unchanged";return}e[i]="added"}),e}var F=class extends v.Modal{constructor(e,t){super(e);this.originalEditor=null;this.modifiedEditor=null;this.finalEditor=null;this.finalEditorMirrorEl=null;this.finalEditorMirrorScrollEl=null;this.finalEditorMirrorContentEl=null;this.boundSyncFinalEditorMirror=null;this.boundSyncFinalEditorMirrorFocusIn=null;this.boundSyncFinalEditorMirrorFocusOut=null;this.isDiffVisible=!0;this.diffOverlay=null;this.diffScrollContainer=null;this.diffOverlayScrollTop=0;this.diffScrollContainerScrollTop=0;this.diffContainer=null;this.isDiffDirty=!1;this.copyFlashTimer=null;this.leftPanel=null;this.middlePanel=null;this.rightPanel=null;this.isPointerInSidePanels=!1;this.isEditModeEnabled=!1;this.toggleEditModeBtn=null;this.boundHandleKeyDown=null;this.fontDisplayEl=null;this.history=[];this.historyIndex=0;this.isComposing=!1;this.preCompositionText="";this.finalEditorFlashRange=null;this.boundFinalEditorBeforeInput=null;this.originalText=t.originalText,this.modifiedText=t.modifiedText,this.onApply=t.onApply,this.fontSize=t.fontSize||14,this.plugin=t.plugin,this.diffViewPosition=t.defaultDiffPosition||"center"}onOpen(){console.log("HybridDiffModal opening..."),console.log("Original text:",this.originalText),console.log("Modified text:",this.modifiedText),this.titleEl.setText("Diff Apply"),this.modalEl.addClass("hybrid-diff-modal"),this.modalEl.style.width="95vw",this.modalEl.style.maxWidth="1400px",this.modalEl.style.height="85vh",this.modalEl.style.overflow="hidden";let e=this.contentEl.createDiv({cls:"hybrid-diff-container"});e.style.display="flex",e.style.flexDirection="column",e.style.height="100%",e.style.gap="10px";let t=e.createDiv({cls:"hybrid-hint"});t.setText("Left: original, right: modified. Press Enter to copy selection to middle editor. Use Cmd+, / Cmd+. to move diff view, Cmd+/ to toggle visibility. Cmd+Z to undo."),t.style.padding="8px",t.style.background="#f0f0f0",t.style.borderRadius="4px",t.style.fontSize=`${this.fontSize-1}px`,t.style.color="#666";let i=e.createDiv({cls:"hybrid-editors-container"});i.style.display="flex",i.style.flex="1",i.style.gap="10px",i.style.minHeight="0",console.log("Editors container created:",i),this.createPanels(i),this.addHybridActions(e),this.addKeyboardShortcuts()}computeLineDiff(e,t){return J(e,t)}computeModifiedLineDiff(e,t){return Z(e,t)}createPanels(e){this.leftPanel=e.createDiv({cls:"hybrid-panel original"}),this.leftPanel.style.flex="1",this.leftPanel.style.display="flex",this.leftPanel.style.flexDirection="column",this.leftPanel.style.border="1px solid #ccc",this.leftPanel.style.borderRadius="4px",this.leftPanel.style.minHeight="0";let t=this.leftPanel.createDiv({cls:"panel-header"});t.setText("Original"),t.style.padding="8px",t.style.background="#f5f5f5",t.style.borderBottom="1px solid #ccc",t.style.fontWeight="bold",t.style.flexShrink="0";let i=this.leftPanel.createDiv({cls:"panel-content"});i.style.flex="1",i.style.padding="0",i.style.overflow="hidden",i.style.minHeight="0",i.style.position="relative";let n=this.createReadOnlyEditor(i,this.originalText,!0);n.style.height="100%",this.originalEditor=n,this.middlePanel=e.createDiv({cls:"hybrid-panel editable"}),this.middlePanel.style.flex="1",this.middlePanel.style.display="flex",this.middlePanel.style.flexDirection="column",this.middlePanel.style.border="2px solid #4CAF50",this.middlePanel.style.borderRadius="4px",this.middlePanel.style.minHeight="0";let l=this.middlePanel.createDiv({cls:"panel-header"});l.setText("Editor"),l.style.padding="8px",l.style.background="#4CAF50",l.style.color="white",l.style.fontWeight="bold",l.style.flexShrink="0";let s=this.middlePanel.createDiv({cls:"panel-content"});s.style.flex="1",s.style.padding="0",s.style.overflow="hidden",s.style.minHeight="0",s.style.position="relative";let d=this.createEditableEditor(s,"");d.style.height="100%",this.finalEditor=d,this.setupFinalEditorMirror(s),this.rightPanel=e.createDiv({cls:"hybrid-panel modified"}),this.rightPanel.style.flex="1",this.rightPanel.style.display="flex",this.rightPanel.style.flexDirection="column",this.rightPanel.style.border="1px solid #ccc",this.rightPanel.style.borderRadius="4px",this.rightPanel.style.minHeight="0";let a=this.rightPanel.createDiv({cls:"panel-header"});a.setText("Modified"),a.style.padding="8px",a.style.background="#f5f5f5",a.style.borderBottom="1px solid #ccc",a.style.fontWeight="bold",a.style.flexShrink="0";let f=this.rightPanel.createDiv({cls:"panel-content"});f.style.flex="1",f.style.padding="0",f.style.overflow="hidden",f.style.minHeight="0",f.style.position="relative";let c=this.createReadOnlyEditor(f,this.modifiedText,!1);c.style.height="100%",this.modifiedEditor=c;let h=u=>{this.isPointerInSidePanels=u,this.syncFinalEditorMirror()};this.leftPanel.addEventListener("pointerenter",()=>h(!0)),this.leftPanel.addEventListener("pointerleave",()=>h(!1)),this.rightPanel.addEventListener("pointerenter",()=>h(!0)),this.rightPanel.addEventListener("pointerleave",()=>h(!1)),this.updatePanelContents()}setupFinalEditorMirror(e){if(!this.finalEditor)return;let t=e.createDiv({cls:"diff-apply-editor-mirror"}),i=t.createDiv({cls:"diff-apply-editor-mirror-scroll"}),n=i.createDiv({cls:"diff-apply-editor-mirror-content"});this.finalEditorMirrorEl=t,this.finalEditorMirrorScrollEl=i,this.finalEditorMirrorContentEl=n,this.syncFinalEditorMirrorStyles();let l=()=>this.syncFinalEditorMirror();this.boundSyncFinalEditorMirror=l,this.finalEditor.addEventListener("input",l),this.finalEditor.addEventListener("select",l),this.finalEditor.addEventListener("keyup",l),this.finalEditor.addEventListener("mouseup",l),this.finalEditor.addEventListener("scroll",l),this.boundFinalEditorBeforeInput=()=>this.cancelFinalEditorFlashSelection(),this.finalEditor.addEventListener("beforeinput",this.boundFinalEditorBeforeInput,!0),this.boundSyncFinalEditorMirrorFocusIn=()=>l(),this.boundSyncFinalEditorMirrorFocusOut=()=>window.setTimeout(l,0),this.modalEl.addEventListener("focusin",this.boundSyncFinalEditorMirrorFocusIn,{capture:!0}),this.modalEl.addEventListener("focusout",this.boundSyncFinalEditorMirrorFocusOut,{capture:!0}),this.syncFinalEditorMirror()}cancelFinalEditorFlashSelection(){if(!this.finalEditorFlashRange||!this.finalEditor)return;let{start:e,end:t}=this.finalEditorFlashRange;this.finalEditor.selectionStart===e&&this.finalEditor.selectionEnd===t&&this.finalEditor.setSelectionRange(t,t),this.finalEditorFlashRange=null,this.copyFlashTimer&&(clearTimeout(this.copyFlashTimer),this.copyFlashTimer=null)}syncFinalEditorMirrorStyles(){if(!this.finalEditor||!this.finalEditorMirrorEl||!this.finalEditorMirrorScrollEl)return;let e=window.getComputedStyle(this.finalEditor);this.finalEditorMirrorEl.style.position="absolute",this.finalEditorMirrorEl.style.top="0",this.finalEditorMirrorEl.style.left="0",this.finalEditorMirrorEl.style.right="0",this.finalEditorMirrorEl.style.bottom="0",this.finalEditorMirrorEl.style.pointerEvents="none",this.finalEditorMirrorEl.style.zIndex="2",this.finalEditorMirrorEl.style.display="none",this.finalEditorMirrorScrollEl.style.width="100%",this.finalEditorMirrorScrollEl.style.height="100%",this.finalEditorMirrorScrollEl.style.overflow="auto",this.finalEditorMirrorScrollEl.style.boxSizing=e.boxSizing,this.finalEditorMirrorScrollEl.style.padding=e.padding,this.finalEditorMirrorScrollEl.style.fontFamily=e.fontFamily,this.finalEditorMirrorScrollEl.style.fontSize=e.fontSize,this.finalEditorMirrorScrollEl.style.lineHeight=e.lineHeight,this.finalEditorMirrorScrollEl.style.letterSpacing=e.letterSpacing,this.finalEditorMirrorScrollEl.style.backgroundColor=e.backgroundColor,this.finalEditorMirrorScrollEl.style.color=e.color,this.finalEditorMirrorScrollEl.style.whiteSpace="pre-wrap",this.finalEditorMirrorScrollEl.style.wordBreak="break-word"}syncFinalEditorMirror(){var s,d,a;if(!this.finalEditor||!this.finalEditorMirrorEl||!this.finalEditorMirrorScrollEl||!this.finalEditorMirrorContentEl)return;let e=document.activeElement;if(!(e===this.originalEditor||e===this.modifiedEditor||this.isPointerInSidePanels)){this.finalEditorMirrorEl.style.display="none";return}this.finalEditorMirrorScrollEl.scrollTop=this.finalEditor.scrollTop,this.finalEditorMirrorScrollEl.scrollLeft=this.finalEditor.scrollLeft;let i=(s=this.finalEditor.value)!=null?s:"",n=(d=this.finalEditor.selectionStart)!=null?d:0,l=(a=this.finalEditor.selectionEnd)!=null?a:0;if(document.activeElement===this.finalEditor){this.finalEditorMirrorEl.style.display="none";return}this.finalEditorMirrorEl.style.display="block",this.renderFinalEditorMirrorContent(i,n,l)}renderFinalEditorMirrorContent(e,t,i){if(!this.finalEditorMirrorContentEl)return;let n=this.finalEditorMirrorContentEl;n.textContent="";let l=Math.max(0,Math.min(t,e.length)),s=Math.max(0,Math.min(i,e.length)),d=Math.min(l,s),a=Math.max(l,s),f=document.createDocumentFragment(),c=e.slice(0,d),h=e.slice(a);if(c&&f.appendChild(document.createTextNode(c)),d!==a){let u=document.createElement("span");u.className="diff-apply-editor-mirror-selection",u.textContent=e.slice(d,a),f.appendChild(u)}else{let u=document.createElement("span");u.className="diff-apply-editor-mirror-caret",u.textContent="\u200B",f.appendChild(u)}h&&f.appendChild(document.createTextNode(h)),n.appendChild(f)}updatePanelContents(){if(this.clearAllDiffOverlays(),this.isDiffVisible){let e=null;switch(this.diffViewPosition){case"left":e=this.leftPanel;break;case"center":e=this.middlePanel;break;case"right":e=this.rightPanel;break}if(e){let t=e.querySelector(".panel-content");t&&(this.createDiffOverlay(t),this.isDiffDirty=!1,this.restoreDiffScroll())}}}saveDiffScroll(){this.diffOverlay&&(this.diffOverlayScrollTop=this.diffOverlay.scrollTop),this.diffScrollContainer&&(this.diffScrollContainerScrollTop=this.diffScrollContainer.scrollTop)}restoreDiffScroll(){this.diffOverlay&&(this.diffOverlay.scrollTop=this.diffOverlayScrollTop),this.diffScrollContainer&&(this.diffScrollContainer.scrollTop=this.diffScrollContainerScrollTop)}clearAllDiffOverlays(){this.saveDiffScroll(),[this.leftPanel,this.middlePanel,this.rightPanel].forEach(e=>{if(e){let t=e.querySelector(".diff-overlay");t&&t.remove()}}),this.diffOverlay=null,this.diffScrollContainer=null,this.diffContainer=null}switchDiffPosition(e){this.diffViewPosition=e,this.updatePanelContents()}moveDiffLeft(){this.diffViewPosition==="center"?(this.diffViewPosition="left",this.updatePanelContents()):this.diffViewPosition==="right"&&(this.diffViewPosition="center",this.updatePanelContents())}moveDiffRight(){this.diffViewPosition==="left"?(this.diffViewPosition="center",this.updatePanelContents()):this.diffViewPosition==="center"&&(this.diffViewPosition="right",this.updatePanelContents())}toggleDiffVisibility(){this.isDiffVisible=!this.isDiffVisible,this.isDiffVisible?this.showDiffOverlay():this.hideDiffOverlay()}showDiffOverlay(){if(!this.diffOverlay||this.isDiffDirty){this.updatePanelContents();return}this.diffOverlay.style.display="block",this.restoreDiffScroll()}hideDiffOverlay(){this.diffOverlay&&(this.saveDiffScroll(),this.diffOverlay.style.display="none")}createReadOnlyEditor(e,t,i=!1){console.log("Creating readonly editor, isOriginal:",i,"text length:",t.length);let n=e.createEl("textarea");return n.value=t,n.style.width="100%",n.style.height="100%",n.style.border="none",n.style.outline="none",n.style.resize="none",n.style.fontFamily="monospace",n.style.fontSize=`${this.fontSize}px`,n.style.lineHeight="1.5",n.style.backgroundColor="#fafafa",n.style.overflow="auto",n.style.whiteSpace="pre-wrap",n.style.wordWrap="break-word",n.style.userSelect="text",n.style.cursor="text",n.readOnly=!0,n.addEventListener("input",()=>{this.isEditModeEnabled&&(this.isDiffVisible?window.setTimeout(()=>{this.updateDiffView()},100):this.isDiffDirty=!0)}),n.addEventListener("dblclick",l=>{if(this.isEditModeEnabled)return;l.preventDefault();let s=n.selectionStart,d=n.value.lastIndexOf(`
`,s-1)+1,a=n.value.indexOf(`
`,s);a===-1&&(a=n.value.length);let f=n.value.substring(d,a);if(f.trim()!==""){if(!this.finalEditor)return;let c=this.plugin.settings.smartDblClickInsertNewlines?U(n.value,d):0,u=j(this.finalEditor.value,this.finalEditor.selectionStart,c)+f;this.insertAtCursor(this.finalEditor,u)}window.setTimeout(()=>{n.setSelectionRange(s,s)},0)}),i?(this.originalEditor=n,console.log("Original editor saved:",this.originalEditor)):(this.modifiedEditor=n,console.log("Modified editor saved:",this.modifiedEditor)),n}createEditableEditor(e,t){let i=e.createEl("textarea");return i.value=t,i.style.width="100%",i.style.height="100%",i.style.border="none",i.style.outline="none",i.style.resize="none",i.style.fontFamily="monospace",i.style.fontSize=`${this.fontSize}px`,i.style.lineHeight="1.5",i.style.backgroundColor="white",i.style.overflow="auto",this.history=[t],this.historyIndex=0,this.isComposing=!1,this.preCompositionText=t,i.addEventListener("compositionstart",()=>{this.isComposing=!0,this.preCompositionText=i.value}),i.addEventListener("compositionend",()=>{this.isComposing=!1,this.addToHistory(i.value)}),i.addEventListener("input",()=>{this.isComposing||this.addToHistory(i.value)}),i.addEventListener("keydown",n=>{(n.metaKey||n.ctrlKey)&&n.key==="z"&&!n.shiftKey&&(n.preventDefault(),this.isComposing?(i.value=this.preCompositionText,this.isComposing=!1,this.historyIndex=this.history.indexOf(this.preCompositionText),this.historyIndex===-1&&this.addToHistory(this.preCompositionText)):this.historyIndex>0&&(this.historyIndex--,i.value=this.history[this.historyIndex]),i.focus()),(n.metaKey||n.ctrlKey)&&(n.key==="y"||n.key==="z"&&n.shiftKey)&&(n.preventDefault(),this.historyIndex<this.history.length-1&&(this.historyIndex++,i.value=this.history[this.historyIndex],i.focus()))}),i}addToHistory(e){this.historyIndex<this.history.length-1&&(this.history=this.history.slice(0,this.historyIndex+1)),this.history.push(e),this.historyIndex++,this.history.length>100&&(this.history.shift(),this.historyIndex--)}addHybridActions(e){let t=e.createDiv({cls:"hybrid-actions"});t.style.display="flex",t.style.gap="10px",t.style.padding="10px 0",t.style.justifyContent="center",t.style.flexWrap="wrap",this.toggleEditModeBtn=t.createEl("button",{text:"Edit Mode"}),this.toggleEditModeBtn.style.padding="8px 16px",this.toggleEditModeBtn.style.backgroundColor="#2196F3",this.toggleEditModeBtn.style.color="white",this.toggleEditModeBtn.style.border="none",this.toggleEditModeBtn.style.borderRadius="4px",this.toggleEditModeBtn.style.cursor="pointer";let i=t.createEl("button",{text:"Clear"});i.style.padding="8px 16px",i.style.backgroundColor="#f44336",i.style.color="white",i.style.border="none",i.style.borderRadius="4px",i.style.cursor="pointer";let n=t.createEl("button",{text:"Apply",cls:"mod-cta"});n.style.padding="8px 16px",n.style.backgroundColor="#4CAF50",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.cursor="pointer";let l=t.createEl("button",{text:"Cancel"});l.style.padding="8px 16px",l.style.backgroundColor="#666",l.style.color="white",l.style.border="none",l.style.borderRadius="4px",l.style.cursor="pointer";let s=t.createDiv();s.style.display="flex",s.style.alignItems="center",s.style.gap="8px",s.style.marginLeft="20px";let d=s.createEl("span",{text:"size:"});d.style.fontSize="14px",d.style.color="#ccc";let a=s.createEl("button",{text:"-"});a.style.padding="4px 8px",a.style.borderRadius="4px",a.style.border="1px solid #666",a.style.backgroundColor="#333",a.style.color="white",a.style.cursor="pointer",this.fontDisplayEl=s.createEl("span",{text:`${this.fontSize}px`}),this.fontDisplayEl.style.fontSize="14px",this.fontDisplayEl.style.color="#ccc",this.fontDisplayEl.style.minWidth="40px",this.fontDisplayEl.style.textAlign="center";let f=s.createEl("button",{text:"+"});f.style.padding="4px 8px",f.style.borderRadius="4px",f.style.border="1px solid #666",f.style.backgroundColor="#333",f.style.color="white",f.style.cursor="pointer",this.toggleEditModeBtn.addEventListener("click",()=>{this.toggleEditMode()}),i.addEventListener("click",()=>{this.finalEditor&&(this.finalEditor.value="")}),n.addEventListener("click",()=>{this.finalEditor&&(this.onApply(this.finalEditor.value),this.close())}),l.addEventListener("click",()=>{this.close()}),a.addEventListener("click",()=>{let c=Math.max(10,this.fontSize-1);this.fontDisplayEl&&(this.fontDisplayEl.textContent=`${c}px`),this.updateFontSize(c),this.plugin&&(this.plugin.settings.fontSize=c,this.plugin.saveSettings())}),f.addEventListener("click",()=>{let c=Math.min(24,this.fontSize+1);this.fontDisplayEl&&(this.fontDisplayEl.textContent=`${c}px`),this.updateFontSize(c),this.plugin&&(this.plugin.settings.fontSize=c,this.plugin.saveSettings())})}copyFromOriginal(){if(!this.originalEditor||!this.finalEditor)return;let e=this.getSelectedText(this.originalEditor);e?this.insertAtCursor(this.finalEditor,e):new v.Notice("Please check what you want to copy in the original text")}copyFromModified(){if(!this.modifiedEditor||!this.finalEditor)return;let e=this.getSelectedText(this.modifiedEditor);e?this.insertAtCursor(this.finalEditor,e):new v.Notice("Please check what you want to copy in the modified text")}copyAllModified(){if(!this.modifiedEditor||!this.finalEditor)return;let e=this.modifiedEditor.value;e?(this.finalEditor.value=e,new v.Notice("Have copied.")):new v.Notice("Modified version is empty.")}getSelectedText(e){let t=e.selectionStart,i=e.selectionEnd;return t===i?"":e.value.substring(t,i)}insertAtCursor(e,t){if(e.tagName!=="TEXTAREA"){console.error("insertAtCursor \u53EA\u80FD\u7528\u4E8Etextarea\u5143\u7D20");return}let i=e.scrollTop,n=e.selectionStart,l=e.selectionEnd,s=e.value.substring(0,n),d=e.value.substring(l),a=n,f=n+t.length,c=s+t+d;e.value=c,e.focus(),this.flashCopiedRange(e,a,f),e.scrollTop=i;let h=new Event("input",{bubbles:!0});e.dispatchEvent(h),this.syncFinalEditorMirror()}flashCopiedRange(e,t,i){t!==i&&(e===this.finalEditor&&(this.finalEditorFlashRange={start:t,end:i}),e.setSelectionRange(t,i),this.copyFlashTimer&&clearTimeout(this.copyFlashTimer),this.copyFlashTimer=setTimeout(()=>{e.selectionStart===t&&e.selectionEnd===i&&e.setSelectionRange(i,i),e===this.finalEditor&&(this.finalEditorFlashRange=null)},600))}addKeyboardShortcuts(){this.boundHandleKeyDown||(this.boundHandleKeyDown=this.handleKeyDown.bind(this)),document.addEventListener("keydown",this.boundHandleKeyDown,{capture:!0})}handleKeyDown(e){let t=document.activeElement,i=t?this.modalEl.contains(t):!1,n=document.documentElement;if(!(!i&&t!==document.body&&t!==n&&t!==null)){if((e.metaKey||e.ctrlKey)&&e.key==="/"){e.preventDefault(),this.toggleDiffVisibility();return}if(e.key==="Enter"||e.key==="Return"||e.keyCode===13){if(t===this.finalEditor||this.isEditModeEnabled)return;if(e.preventDefault(),t===this.originalEditor){(this.originalEditor?this.getSelectedText(this.originalEditor):"")?(this.copyFromOriginal(),this.originalEditor&&this.originalEditor.setSelectionRange(this.originalEditor.selectionEnd,this.originalEditor.selectionEnd)):new v.Notice("\u8BF7\u5148\u5728\u539F\u6587\u4E2D\u9009\u62E9\u8981\u590D\u5236\u7684\u6587\u672C");return}if(t===this.modifiedEditor){(this.modifiedEditor?this.getSelectedText(this.modifiedEditor):"")?(this.copyFromModified(),this.modifiedEditor&&this.modifiedEditor.setSelectionRange(this.modifiedEditor.selectionEnd,this.modifiedEditor.selectionEnd)):new v.Notice("\u8BF7\u5148\u5728\u4FEE\u6539\u7248\u4E2D\u9009\u62E9\u8981\u590D\u5236\u7684\u6587\u672C");return}}if(this.isDiffVisible){if((e.metaKey||e.ctrlKey)&&e.key===","){e.preventDefault(),this.moveDiffLeft();return}if((e.metaKey||e.ctrlKey)&&e.key==="."){e.preventDefault(),this.moveDiffRight();return}}}}onClose(){if(this.boundSyncFinalEditorMirror&&this.finalEditor){let e=this.boundSyncFinalEditorMirror;this.finalEditor.removeEventListener("input",e),this.finalEditor.removeEventListener("select",e),this.finalEditor.removeEventListener("keyup",e),this.finalEditor.removeEventListener("mouseup",e),this.finalEditor.removeEventListener("scroll",e),this.boundSyncFinalEditorMirror=null}this.boundFinalEditorBeforeInput&&this.finalEditor&&(this.finalEditor.removeEventListener("beforeinput",this.boundFinalEditorBeforeInput,!0),this.boundFinalEditorBeforeInput=null),this.boundSyncFinalEditorMirrorFocusIn&&(this.modalEl.removeEventListener("focusin",this.boundSyncFinalEditorMirrorFocusIn,!0),this.boundSyncFinalEditorMirrorFocusIn=null),this.boundSyncFinalEditorMirrorFocusOut&&(this.modalEl.removeEventListener("focusout",this.boundSyncFinalEditorMirrorFocusOut,!0),this.boundSyncFinalEditorMirrorFocusOut=null),this.boundHandleKeyDown&&(document.removeEventListener("keydown",this.boundHandleKeyDown,{capture:!0}),this.boundHandleKeyDown=null),this.copyFlashTimer&&(clearTimeout(this.copyFlashTimer),this.copyFlashTimer=null),this.contentEl.empty()}createDiffOverlay(e){this.diffOverlay=e.createDiv({cls:"diff-overlay"}),this.diffOverlay.style.position="absolute",this.diffOverlay.style.top="0",this.diffOverlay.style.left="0",this.diffOverlay.style.width="100%",this.diffOverlay.style.height="100%",this.diffOverlay.style.backgroundColor="rgba(255, 255, 255, 0.95)",this.diffOverlay.style.zIndex="10",this.diffOverlay.style.display="block",this.diffOverlay.style.borderRadius="4px",this.diffOverlay.style.padding="8px",this.diffOverlay.style.boxSizing="border-box",this.diffOverlay.style.overflow="auto",this.diffOverlay.style.cursor="pointer",this.diffOverlay.addEventListener("click",d=>{d.stopPropagation(),this.toggleDiffVisibility()});let t=this.diffOverlay.createDiv({cls:"diff-content"});t.style.display="flex",t.style.flexDirection="column",t.style.height="100%",t.style.gap="4px";let i=t.createDiv({cls:"diff-header"});i.style.display="flex",i.style.justifyContent="space-between",i.style.alignItems="center",i.style.marginBottom="4px";let n=t.createDiv({cls:"unified-diff-panel"});n.style.flex="1",n.style.border="1px solid #ddd",n.style.borderRadius="4px",n.style.overflow="auto",this.diffScrollContainer=n;let l=n.createDiv({cls:"unified-diff-content"});l.style.padding="12px",this.createUnifiedDiffContent(l);let s=t.createDiv({cls:"diff-hint"});s.style.fontSize=`${this.fontSize-1}px`,s.style.color="#666",s.style.textAlign="center",s.style.marginTop="8px"}createUnifiedDiffContent(e){let t=this.originalEditor?this.originalEditor.value:this.originalText,i=this.modifiedEditor?this.modifiedEditor.value:this.modifiedText,n=M(t,i),l=e.createDiv();this.diffContainer=l,l.style.fontFamily="monospace",l.style.fontSize=`${this.fontSize}px`,l.style.lineHeight="1.5",l.style.whiteSpace="pre-wrap",l.style.wordWrap="break-word",n.forEach(s=>{let d=l.createSpan();d.textContent=s.value,s.removed?(d.style.backgroundColor="#ffebee",d.style.color="#d32f2f",d.style.textDecoration="line-through",d.style.textDecorationColor="#d32f2f",d.style.textDecorationThickness="2px"):s.added?(d.style.backgroundColor="#e8f5e8",d.style.color="#2e7d32"):d.style.color="#333"})}updateFontSize(e){this.fontSize=e,this.originalEditor&&(this.originalEditor.style.fontSize=`${e}px`),this.modifiedEditor&&(this.modifiedEditor.style.fontSize=`${e}px`),this.finalEditor&&(this.finalEditor.style.fontSize=`${e}px`),this.syncFinalEditorMirrorStyles(),this.syncFinalEditorMirror(),this.diffContainer&&(this.diffContainer.style.fontSize=`${e}px`),this.fontDisplayEl&&(this.fontDisplayEl.textContent=`${e}px`),this.isDiffVisible&&this.updateDiffView()}toggleEditMode(){this.isEditModeEnabled=!this.isEditModeEnabled,this.toggleEditModeBtn&&(this.isEditModeEnabled?(this.toggleEditModeBtn.textContent="Read Only",this.toggleEditModeBtn.style.backgroundColor="#FF9800"):(this.toggleEditModeBtn.textContent="Edit Mode",this.toggleEditModeBtn.style.backgroundColor="#2196F3")),this.originalEditor&&(this.originalEditor.readOnly=!this.isEditModeEnabled),this.modifiedEditor&&(this.modifiedEditor.readOnly=!this.isEditModeEnabled),new v.Notice(this.isEditModeEnabled?"Edit Mode":"Read Only"),this.updateDiffView()}updateDiffView(){if(!this.isDiffVisible)return;let e=this.originalEditor?this.originalEditor.value:this.originalText,t=this.modifiedEditor?this.modifiedEditor.value:this.modifiedText;this.originalText=e,this.modifiedText=t,this.updatePanelContents()}};var z={fontSize:14,defaultDiffPosition:"center",smartDblClickInsertNewlines:!0};var P=class extends O.Plugin{constructor(){super(...arguments);this.settings=z}async onload(){await this.loadSettings(),this.addSettingTab(new T(this.app,this)),this.addCommand({id:"diff-apply-hybrid",name:"\u6DF7\u5408\u7F16\u8F91\u6240\u9009\u6587\u672C",editorCallback:e=>this.openHybridDiffForSelection(e)}),this.registerEvent(this.app.workspace.on("editor-menu",(e,t)=>{let i=t.getSelection();i&&i.length>0&&e.addItem(n=>n.setTitle("\u6DF7\u5408\u7F16\u8F91\uFF08Hybrid Diff\uFF09").setIcon("edit").onClick(()=>this.openHybridDiffForSelection(t)))}))}onunload(){}async loadSettings(){this.settings=Object.assign({},z,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async openHybridDiffForSelection(e){let t=e.getSelection();if(!t||t.length===0){new O.Notice("\u8BF7\u5148\u5728\u7B14\u8BB0\u4E2D\u9009\u4E2D\u8981\u5BF9\u6BD4\u7684\u539F\u6587\u7247\u6BB5\u3002");return}let i="";try{i=await navigator.clipboard.readText()}catch(d){console.warn("\u65E0\u6CD5\u8BFB\u53D6\u526A\u8D34\u677F\u5185\u5BB9\uFF0C\u53EF\u80FD\u662F\u6743\u9650\u95EE\u9898",d)}let n=e.getCursor("from"),l=e.getCursor("to");new F(this.app,{originalText:t,modifiedText:i,onApply:d=>{e.replaceRange(d,n,l)},fontSize:this.settings.fontSize,defaultDiffPosition:this.settings.defaultDiffPosition,plugin:this}).open()}};
