"use strict";var B=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var Q=Object.prototype.hasOwnProperty;var _=(o,n)=>{for(var e in n)B(o,e,{get:n[e],enumerable:!0})},ee=(o,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let i of X(n))!Q.call(o,i)&&i!==e&&B(o,i,{get:()=>n[i],enumerable:!(t=Z(n,i))||t.enumerable});return o};var te=o=>ee(B({},"__esModule",{value:!0}),o);var ce={};_(ce,{default:()=>I});module.exports=te(ce);var A=require("obsidian");var ie={"command.hybrid.name":"Hybrid edit selection","menu.hybrid.title":"Hybrid Edit (Hybrid Diff)","notice.selectOriginalSegment":"Select the original text in the note first.","notice.clipboardReadFailed":"Failed to read clipboard content (permission?).","modal.header.original":"Original","modal.header.editor":"Editor","modal.header.modified":"Modified","modal.header.shortcutsAriaLabel":"Keyboard shortcuts","modal.header.settingsAriaLabel":"Settings","modal.toggle.readOnly":"Read Only","modal.toggle.editMode":"Edit Mode","modal.action.clear":"Clear","modal.action.apply":"Apply","modal.action.cancel":"Cancel","modal.diffGranularity.label":"Diff:","modal.diffGranularity.word":"Word","modal.diffGranularity.char":"Char","modal.fontSize.label":"Size:","modal.fontSize.decreaseAriaLabel":"Decrease font size","modal.fontSize.increaseAriaLabel":"Increase font size","modal.notice.readOnly":"Read Only","modal.notice.editMode":"Edit Mode","modal.notice.selectTextInOriginal":"Select text in Original to copy first.","modal.notice.selectTextInModified":"Select text in Modified to copy first.","modal.notice.copied":"Copied.","modal.notice.modifiedEmpty":"Modified version is empty.","modal.notice.shortcutsHint":"Shortcuts: Enter to copy selection from focused side pane; Cmd/Ctrl+Z undo; Cmd/Ctrl+Shift+Z or Ctrl+Y redo; Esc closes.","modal.notice.settingsNotAvailable":"Settings are not available yet."};function k(o){var n;return(n=ie[o])!=null?n:o}var L=require("obsidian");function D(){}D.prototype={diff:function(n,e){var t,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},r=i.callback;typeof i=="function"&&(r=i,i={}),this.options=i;var l=this;function s(E){return r?(setTimeout(function(){r(void 0,E)},0),!0):E}n=this.castInput(n),e=this.castInput(e),n=this.removeEmpty(this.tokenize(n)),e=this.removeEmpty(this.tokenize(e));var a=e.length,d=n.length,h=1,c=a+d;i.maxEditLength&&(c=Math.min(c,i.maxEditLength));var g=(t=i.timeout)!==null&&t!==void 0?t:1/0,v=Date.now()+g,p=[{oldPos:-1,lastComponent:void 0}],y=this.extractCommon(p[0],e,n,0);if(p[0].oldPos+1>=d&&y+1>=a)return s([{value:this.join(e),count:e.length}]);var f=-1/0,u=1/0;function m(){for(var E=Math.max(f,-h);E<=Math.min(u,h);E+=2){var b=void 0,T=p[E-1],x=p[E+1];T&&(p[E-1]=void 0);var w=!1;if(x){var O=x.oldPos-E;w=x&&0<=O&&O<a}var M=T&&T.oldPos+1<d;if(!w&&!M){p[E]=void 0;continue}if(!M||w&&T.oldPos+1<x.oldPos?b=l.addToPath(x,!0,void 0,0):b=l.addToPath(T,void 0,!0,1),y=l.extractCommon(b,e,n,E),b.oldPos+1>=d&&y+1>=a)return s(re(l,b.lastComponent,e,n,l.useLongestToken));p[E]=b,b.oldPos+1>=d&&(u=Math.min(u,E-1)),y+1>=a&&(f=Math.max(f,E+1))}h++}if(r)(function E(){setTimeout(function(){if(h>c||Date.now()>v)return r();m()||E()},0)})();else for(;h<=c&&Date.now()<=v;){var S=m();if(S)return S}},addToPath:function(n,e,t,i){var r=n.lastComponent;return r&&r.added===e&&r.removed===t?{oldPos:n.oldPos+i,lastComponent:{count:r.count+1,added:e,removed:t,previousComponent:r.previousComponent}}:{oldPos:n.oldPos+i,lastComponent:{count:1,added:e,removed:t,previousComponent:r}}},extractCommon:function(n,e,t,i){for(var r=e.length,l=t.length,s=n.oldPos,a=s-i,d=0;a+1<r&&s+1<l&&this.equals(e[a+1],t[s+1]);)a++,s++,d++;return d&&(n.lastComponent={count:d,previousComponent:n.lastComponent}),n.oldPos=s,a},equals:function(n,e){return this.options.comparator?this.options.comparator(n,e):n===e||this.options.ignoreCase&&n.toLowerCase()===e.toLowerCase()},removeEmpty:function(n){for(var e=[],t=0;t<n.length;t++)n[t]&&e.push(n[t]);return e},castInput:function(n){return n},tokenize:function(n){return n.split("")},join:function(n){return n.join("")}};function re(o,n,e,t,i){for(var r=[],l;n;)r.push(n),l=n.previousComponent,delete n.previousComponent,n=l;r.reverse();for(var s=0,a=r.length,d=0,h=0;s<a;s++){var c=r[s];if(c.removed){if(c.value=o.join(t.slice(h,h+c.count)),h+=c.count,s&&r[s-1].added){var v=r[s-1];r[s-1]=r[s],r[s]=v}}else{if(!c.added&&i){var g=e.slice(d,d+c.count);g=g.map(function(y,f){var u=t[h+f];return u.length>y.length?u:y}),c.value=o.join(g)}else c.value=o.join(e.slice(d,d+c.count));d+=c.count,c.added||(h+=c.count)}}var p=r[a-1];return a>1&&typeof p.value=="string"&&(p.added||p.removed)&&o.equals("",p.value)&&(r[a-2].value+=p.value,r.pop()),r}var ne=new D;function z(o,n,e){return ne.diff(o,n,e)}var G=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,W=/\S/,K=new D;K.equals=function(o,n){return this.options.ignoreCase&&(o=o.toLowerCase(),n=n.toLowerCase()),o===n||this.options.ignoreWhitespace&&!W.test(o)&&!W.test(n)};K.tokenize=function(o){for(var n=o.split(/([^\S\r\n]+|[()[\]{}'"\r\n]|\b)/),e=0;e<n.length-1;e++)!n[e+1]&&n[e+2]&&G.test(n[e])&&G.test(n[e+2])&&(n[e]+=n[e+2],n.splice(e+1,2),e--);return n};var U=new D;U.tokenize=function(o){this.options.stripTrailingCr&&(o=o.replace(/\r\n/g,`
`));var n=[],e=o.split(/(\n|\r\n)/);e[e.length-1]||e.pop();for(var t=0;t<e.length;t++){var i=e[t];t%2&&!this.options.newlineIsToken?n[n.length-1]+=i:(this.options.ignoreWhitespace&&(i=i.trim()),n.push(i))}return n};var le=new D;le.tokenize=function(o){return o.split(/(\S.+?[.!?])(?=\s+|$)/)};var oe=new D;oe.tokenize=function(o){return o.split(/([{}:;,]|\s+)/)};function C(o){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?C=function(n){return typeof n}:C=function(n){return n&&typeof Symbol=="function"&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},C(o)}var se=Object.prototype.toString,F=new D;F.useLongestToken=!0;F.tokenize=U.tokenize;F.castInput=function(o){var n=this.options,e=n.undefinedReplacement,t=n.stringifyReplacer,i=t===void 0?function(r,l){return typeof l=="undefined"?e:l}:t;return typeof o=="string"?o:JSON.stringify(R(o,null,null,i),i,"  ")};F.equals=function(o,n){return D.prototype.equals.call(F,o.replace(/,([\r\n])/g,"$1"),n.replace(/,([\r\n])/g,"$1"))};function R(o,n,e,t,i){n=n||[],e=e||[],t&&(o=t(i,o));var r;for(r=0;r<n.length;r+=1)if(n[r]===o)return e[r];var l;if(se.call(o)==="[object Array]"){for(n.push(o),l=new Array(o.length),e.push(l),r=0;r<o.length;r+=1)l[r]=R(o[r],n,e,t,i);return n.pop(),e.pop(),l}if(o&&o.toJSON&&(o=o.toJSON()),C(o)==="object"&&o!==null){n.push(o),l={},e.push(l);var s=[],a;for(a in o)o.hasOwnProperty(a)&&s.push(a);for(s.sort(),r=0;r<s.length;r+=1)a=s[r],l[a]=R(o[a],n,e,t,a);n.pop(),e.pop()}else l=o;return l}var H=new D;H.tokenize=function(o){return o.slice()};H.join=H.removeEmpty=function(o){return o};function $(o,n,e){return H.diff(o,n,e)}function q(o,n){if(n<=0)return 1;let e=n-1,t=o.lastIndexOf(`
`,e-1)+1;return o.substring(t,e).trim().length===0?2:1}function V(o,n,e){if(e<=0||o.length===0||n<=0||n>o.length)return"";let t=o[n-1],i=o.indexOf(`
`,n);if(t!==`
`&&(i!==-1&&n<i||i===-1&&n<o.length))return"";let l=0;for(let a=n-1;a>=0&&o[a]===`
`;a-=1)l+=1;let s=Math.max(0,e-l);return`
`.repeat(s)}function j(o,n){let e={};return o.forEach((t,i)=>{if(i<n.length){let r=n[i];if(t===r){e[i]="unchanged";return}z(t,r).some(a=>a.added||a.removed)?r.trim()!==""?e[i]="modified":e[i]="removed":e[i]="unchanged";return}e[i]="removed"}),e}function J(o,n){let e={};return n.forEach((t,i)=>{if(i<o.length){let r=o[i];if(t===r){e[i]="unchanged";return}if(r.trim()===""&&t.trim()!==""){e[i]="added";return}z(r,t).some(a=>a.added||a.removed)&&r.trim()===""?e[i]="added":e[i]="unchanged";return}e[i]="added"}),e}var ae="background",de="background",fe=!0,P=class extends L.Modal{constructor(e,t){var i;super(e);this.originalEditor=null;this.modifiedEditor=null;this.finalEditor=null;this.finalEditorMirrorEl=null;this.finalEditorMirrorScrollEl=null;this.finalEditorMirrorContentEl=null;this.boundSyncFinalEditorMirror=null;this.boundSyncFinalEditorMirrorFocusIn=null;this.boundSyncFinalEditorMirrorFocusOut=null;this.leftHoverState="default";this.rightHoverState="default";this.leftDiffOverlay=null;this.rightDiffOverlay=null;this.leftDiffLayers=null;this.rightDiffLayers=null;this.copyFlashTimer=null;this.leftPanel=null;this.middlePanel=null;this.rightPanel=null;this.isPointerInSidePanels=!1;this.isEditModeEnabled=!1;this.toggleEditModeWrapper=null;this.toggleEditModeLabelEl=null;this.boundHandleKeyDown=null;this.fontDisplayEl=null;this.diffGranularityBtnEls={};this.isSyncingScroll=!1;this.leftTextareaScrollListener=null;this.rightTextareaScrollListener=null;this.leftOverlayScrollListener=null;this.rightOverlayScrollListener=null;this.ignoreNextScrollEventTargets=new WeakSet;this.history=[];this.historyIndex=0;this.isComposing=!1;this.preCompositionText="";this.finalEditorFlashRange=null;this.boundFinalEditorBeforeInput=null;this.originalText=t.originalText,this.modifiedText=t.modifiedText,this.onApply=t.onApply,this.fontSize=t.fontSize||14,this.diffGranularity=(i=t.diffGranularity)!=null?i:"word",this.plugin=t.plugin}onOpen(){this.titleEl.empty();let t=this.titleEl.createDiv({cls:"merge-header"}).createDiv({cls:"brand"}),i=t.createSpan({cls:"brand-icon",attr:{"aria-hidden":"true"}});(0,L.setIcon)(i,"git-merge"),t.createEl("span",{text:"Merge Conflict Resolver"}),this.modalEl.addClass("hybrid-diff-modal"),this.modalEl.addClass("merge-conflict-view"),this.modalEl.style.setProperty("--hybrid-font-size",`${this.fontSize}px`),this.applyDiffThemeSettings();let r=this.contentEl.createDiv({cls:"hybrid-diff-container"}),l=r.createDiv({cls:"hybrid-editors-container"});this.createPanels(l),this.addHybridActions(r),this.addKeyboardShortcuts()}applyDiffThemeSettings(){this.modalEl.dataset.defaultStyle=ae,this.modalEl.dataset.completeStyle=de}computeLineDiff(e,t){return j(e,t)}computeModifiedLineDiff(e,t){return J(e,t)}createPanels(e){this.leftPanel=e.createDiv({cls:"hybrid-panel original"}),this.leftPanel.createDiv({cls:"panel-header"}).setText(this.plugin.t("modal.header.original"));let i=this.leftPanel.createDiv({cls:"panel-content"}),r=this.createReadOnlyEditor(i,this.originalText,!0);r.addClass("diff-active"),this.originalEditor=r;let l=this.createInlineDiffOverlay(i);this.leftDiffOverlay=l.overlay,this.leftDiffLayers={default:l.defaultContent,hover:l.hoverContent,complete:l.completeContent},r.addEventListener("scroll",()=>{this.syncOverlayContentTransformToTextarea("left")}),this.middlePanel=e.createDiv({cls:"hybrid-panel editable"}),this.middlePanel.createDiv({cls:"panel-header"}).setText(this.plugin.t("modal.header.editor"));let a=this.middlePanel.createDiv({cls:"panel-content"}),d=this.createEditableEditor(a,"");this.finalEditor=d,this.setupFinalEditorMirror(a),this.rightPanel=e.createDiv({cls:"hybrid-panel modified"}),this.rightPanel.createDiv({cls:"panel-header"}).setText(this.plugin.t("modal.header.modified"));let c=this.rightPanel.createDiv({cls:"panel-content"}),g=this.createReadOnlyEditor(c,this.modifiedText,!1);g.addClass("diff-active"),this.modifiedEditor=g;let v=this.createInlineDiffOverlay(c);this.rightDiffOverlay=v.overlay,this.rightDiffLayers={default:v.defaultContent,hover:v.hoverContent,complete:v.completeContent},g.addEventListener("scroll",()=>{this.syncOverlayContentTransformToTextarea("right")});let p=y=>{this.isPointerInSidePanels=y,this.syncFinalEditorMirror()};this.leftPanel.addEventListener("pointerenter",()=>p(!0)),this.leftPanel.addEventListener("pointerleave",()=>p(!1)),this.rightPanel.addEventListener("pointerenter",()=>p(!0)),this.rightPanel.addEventListener("pointerleave",()=>p(!1)),this.setupDiffHoverListeners(),this.rebuildReadOnlyDiffCaches(),this.applyReadOnlyInteractionState(),this.syncOverlayContentTransformToTextarea("left"),this.syncOverlayContentTransformToTextarea("right")}setupFinalEditorMirror(e){if(!this.finalEditor)return;let t=e.createDiv({cls:"diff-apply-editor-mirror"}),i=t.createDiv({cls:"diff-apply-editor-mirror-scroll"}),r=i.createDiv({cls:"diff-apply-editor-mirror-content"});this.finalEditorMirrorEl=t,this.finalEditorMirrorScrollEl=i,this.finalEditorMirrorContentEl=r,this.syncFinalEditorMirrorStyles();let l=()=>this.syncFinalEditorMirror();this.boundSyncFinalEditorMirror=l,this.finalEditor.addEventListener("input",l),this.finalEditor.addEventListener("select",l),this.finalEditor.addEventListener("keyup",l),this.finalEditor.addEventListener("mouseup",l),this.finalEditor.addEventListener("scroll",l),this.boundFinalEditorBeforeInput=()=>this.cancelFinalEditorFlashSelection(),this.finalEditor.addEventListener("beforeinput",this.boundFinalEditorBeforeInput,!0),this.boundSyncFinalEditorMirrorFocusIn=()=>l(),this.boundSyncFinalEditorMirrorFocusOut=()=>window.setTimeout(l,0),this.modalEl.addEventListener("focusin",this.boundSyncFinalEditorMirrorFocusIn,{capture:!0}),this.modalEl.addEventListener("focusout",this.boundSyncFinalEditorMirrorFocusOut,{capture:!0}),this.syncFinalEditorMirror()}cancelFinalEditorFlashSelection(){if(!this.finalEditorFlashRange||!this.finalEditor)return;let{start:e,end:t}=this.finalEditorFlashRange;this.finalEditor.selectionStart===e&&this.finalEditor.selectionEnd===t&&this.finalEditor.setSelectionRange(t,t),this.finalEditorFlashRange=null,this.copyFlashTimer&&(clearTimeout(this.copyFlashTimer),this.copyFlashTimer=null)}syncFinalEditorMirrorStyles(){if(!this.finalEditor||!this.finalEditorMirrorEl||!this.finalEditorMirrorScrollEl)return;let e=window.getComputedStyle(this.finalEditor);this.finalEditorMirrorEl.style.position="absolute",this.finalEditorMirrorEl.style.top="0",this.finalEditorMirrorEl.style.left="0",this.finalEditorMirrorEl.style.right="0",this.finalEditorMirrorEl.style.bottom="0",this.finalEditorMirrorEl.style.pointerEvents="none",this.finalEditorMirrorEl.style.zIndex="2",this.finalEditorMirrorEl.style.display="none",this.finalEditorMirrorScrollEl.style.width="100%",this.finalEditorMirrorScrollEl.style.height="100%",this.finalEditorMirrorScrollEl.style.overflow="auto",this.finalEditorMirrorScrollEl.style.boxSizing=e.boxSizing,this.finalEditorMirrorScrollEl.style.padding=e.padding,this.finalEditorMirrorScrollEl.style.fontFamily=e.fontFamily,this.finalEditorMirrorScrollEl.style.fontSize=e.fontSize,this.finalEditorMirrorScrollEl.style.lineHeight=e.lineHeight,this.finalEditorMirrorScrollEl.style.letterSpacing=e.letterSpacing,this.finalEditorMirrorScrollEl.style.backgroundColor=e.backgroundColor,this.finalEditorMirrorScrollEl.style.color=e.color,this.finalEditorMirrorScrollEl.style.whiteSpace="pre-wrap",this.finalEditorMirrorScrollEl.style.wordBreak="break-word"}syncFinalEditorMirror(){var s,a,d;if(!this.finalEditor||!this.finalEditorMirrorEl||!this.finalEditorMirrorScrollEl||!this.finalEditorMirrorContentEl)return;let e=document.activeElement;if(!(e===this.originalEditor||e===this.modifiedEditor||this.isPointerInSidePanels)){this.finalEditorMirrorEl.style.display="none";return}this.finalEditorMirrorScrollEl.scrollTop=this.finalEditor.scrollTop,this.finalEditorMirrorScrollEl.scrollLeft=this.finalEditor.scrollLeft;let i=(s=this.finalEditor.value)!=null?s:"",r=(a=this.finalEditor.selectionStart)!=null?a:0,l=(d=this.finalEditor.selectionEnd)!=null?d:0;if(document.activeElement===this.finalEditor){this.finalEditorMirrorEl.style.display="none";return}this.finalEditorMirrorEl.style.display="block",this.renderFinalEditorMirrorContent(i,r,l)}renderFinalEditorMirrorContent(e,t,i){if(!this.finalEditorMirrorContentEl)return;let r=this.finalEditorMirrorContentEl;r.textContent="";let l=Math.max(0,Math.min(t,e.length)),s=Math.max(0,Math.min(i,e.length)),a=Math.min(l,s),d=Math.max(l,s),h=document.createDocumentFragment(),c=e.slice(0,a),g=e.slice(d);if(c&&h.appendChild(document.createTextNode(c)),a!==d){let v=document.createElement("span");v.className="diff-apply-editor-mirror-selection",v.textContent=e.slice(a,d),h.appendChild(v)}else{let v=document.createElement("span");v.className="diff-apply-editor-mirror-caret",v.textContent="\u200B",h.appendChild(v)}g&&h.appendChild(document.createTextNode(g)),r.appendChild(h)}createReadOnlyEditor(e,t,i=!1){let r=e.createEl("textarea");r.addClass("hybrid-editor"),r.addClass("hybrid-editor--readonly"),r.addClass(i?"hybrid-editor--original":"hybrid-editor--modified"),r.value=t,r.readOnly=!0;let l=null;return r.addEventListener("input",()=>{this.isEditModeEnabled&&(l&&clearTimeout(l),l=setTimeout(()=>{this.updateAllDiffViews()},300))}),r.addEventListener("dblclick",s=>{if(this.isEditModeEnabled)return;s.preventDefault();let a=r.selectionStart,d=r.value.lastIndexOf(`
`,a-1)+1,h=r.value.indexOf(`
`,a);h===-1&&(h=r.value.length);let c=r.value.substring(d,h);if(c.trim()!==""){if(!this.finalEditor)return;let g=fe?q(r.value,d):0,p=V(this.finalEditor.value,this.finalEditor.selectionStart,g)+c;this.insertAtCursor(this.finalEditor,p)}window.setTimeout(()=>{r.setSelectionRange(a,a)},0)}),i?this.originalEditor=r:this.modifiedEditor=r,r}createEditableEditor(e,t){let i=e.createEl("textarea");return i.addClass("hybrid-editor"),i.addClass("hybrid-editor--final"),i.value=t,this.history=[t],this.historyIndex=0,this.isComposing=!1,this.preCompositionText=t,i.addEventListener("compositionstart",()=>{this.isComposing=!0,this.preCompositionText=i.value}),i.addEventListener("compositionend",()=>{this.isComposing=!1,this.addToHistory(i.value)}),i.addEventListener("input",()=>{this.isComposing||this.addToHistory(i.value)}),i.addEventListener("keydown",r=>{(r.metaKey||r.ctrlKey)&&r.key==="z"&&!r.shiftKey&&(r.preventDefault(),this.isComposing?(i.value=this.preCompositionText,this.isComposing=!1,this.historyIndex=this.history.indexOf(this.preCompositionText),this.historyIndex===-1&&this.addToHistory(this.preCompositionText)):this.historyIndex>0&&(this.historyIndex--,i.value=this.history[this.historyIndex]),i.focus()),(r.metaKey||r.ctrlKey)&&(r.key==="y"||r.key==="z"&&r.shiftKey)&&(r.preventDefault(),this.historyIndex<this.history.length-1&&(this.historyIndex++,i.value=this.history[this.historyIndex],i.focus()))}),i}tokenizeInlineDiff(e){if(e.length===0)return[];let t=Intl.Segmenter;if(t){if(this.diffGranularity==="char"){let h=new t(void 0,{granularity:"grapheme"});return Array.from(h.segment(e),c=>c.segment)}let d=new t(void 0,{granularity:"word"});return Array.from(d.segment(e),h=>h.segment)}if(this.diffGranularity==="char")return Array.from(e);let i=[],r="[\\u3400-\\u9FFF\\uF900-\\uFAFF\\u3040-\\u30FF\\uAC00-\\uD7AF\\u1100-\\u11FF\\u3130-\\u318F\\u3000-\\u303F]",l=new RegExp(`(${r})`,"g"),s=new RegExp(`^${r}$`),a=e.split(l).filter(d=>d.length>0);for(let d of a){if(s.test(d)){i.push(d);continue}let h=d.match(/\s+|\S+\s*/g);h&&i.push(...h)}return i}diffInlineText(e,t){let i=this.tokenizeInlineDiff(e),r=this.tokenizeInlineDiff(t);return $(i,r).map(s=>({value:s.value.join(""),added:s.added,removed:s.removed}))}renderDefaultDiffMarks(e,t,i){if(e)if(e.textContent="",i){let r=this.modifiedEditor?this.modifiedEditor.value:this.modifiedText;this.diffInlineText(t,r).forEach(s=>{if(!s.added){let a=e.createSpan();a.textContent=s.value,s.removed&&a.addClass("diff-deleted-default")}})}else{let r=this.originalEditor?this.originalEditor.value:this.originalText;this.diffInlineText(r,t).forEach(s=>{if(!s.removed){let a=e.createSpan();a.textContent=s.value,s.added&&a.addClass("diff-added-default")}})}}renderHoverDiffMarks(e,t,i){if(e)if(e.textContent="",i){let r=this.modifiedEditor?this.modifiedEditor.value:this.modifiedText;this.diffInlineText(t,r).forEach(s=>{if(!s.added){let a=e.createSpan();a.textContent=s.value,s.removed&&a.addClass("diff-deleted-hover")}})}else{let r=this.originalEditor?this.originalEditor.value:this.originalText;this.diffInlineText(r,t).forEach(s=>{if(!s.removed){let a=e.createSpan();a.textContent=s.value,s.added&&a.addClass("diff-added-hover")}})}}renderCompleteDiff(e,t,i){if(!e)return;e.textContent="",this.diffInlineText(t,i).forEach(l=>{let s=e.createSpan();s.textContent=l.value,l.removed?s.addClass("diff-deleted-complete"):l.added&&s.addClass("diff-added-complete")})}setupDiffHoverListeners(){!this.leftPanel||!this.rightPanel||(this.leftPanel.addEventListener("mouseenter",()=>this.handleLeftPanelEnter()),this.leftPanel.addEventListener("mouseleave",()=>this.handleLeftPanelLeave()),this.rightPanel.addEventListener("mouseenter",()=>this.handleRightPanelEnter()),this.rightPanel.addEventListener("mouseleave",()=>this.handleRightPanelLeave()))}handleLeftPanelEnter(){this.isEditModeEnabled||(this.leftHoverState="hovered",this.setOverlayLayer("left","hover"),this.setOverlayLayer("right","complete"),this.setOverlayScrollable("left",!1),this.setOverlayScrollable("right",!0),this.originalEditor&&this.rightDiffOverlay&&(this.leftTextareaScrollListener=e=>{let t=e.currentTarget;if(t&&this.ignoreNextScrollEventTargets.has(t)){this.ignoreNextScrollEventTargets.delete(t);return}this.rightDiffOverlay&&this.syncScrollByPercentage(this.originalEditor,this.rightDiffOverlay)},this.rightOverlayScrollListener=e=>{let t=e.currentTarget;if(t&&this.ignoreNextScrollEventTargets.has(t)){this.ignoreNextScrollEventTargets.delete(t);return}this.originalEditor&&this.syncScrollByPercentage(this.rightDiffOverlay,this.originalEditor)},this.originalEditor.addEventListener("scroll",this.leftTextareaScrollListener),this.rightDiffOverlay.addEventListener("scroll",this.rightOverlayScrollListener),requestAnimationFrame(()=>{this.originalEditor&&this.rightDiffOverlay&&(this.ensureScrollableSpace(this.originalEditor,this.rightDiffOverlay),this.modifiedEditor&&this.ensureScrollableSpace(this.modifiedEditor,this.rightDiffOverlay),this.syncScrollByPercentage(this.originalEditor,this.rightDiffOverlay))})))}handleLeftPanelLeave(){this.isEditModeEnabled||(this.leftHoverState="default",this.setOverlayLayer("left","default"),this.setOverlayLayer("right","default"),this.setOverlayScrollable("right",!1),this.syncOverlayContentTransformToTextarea("right"),this.originalEditor&&this.restoreScrollableSpace(this.originalEditor),this.modifiedEditor&&this.restoreScrollableSpace(this.modifiedEditor),this.leftTextareaScrollListener&&this.originalEditor&&(this.originalEditor.removeEventListener("scroll",this.leftTextareaScrollListener),this.leftTextareaScrollListener=null),this.rightOverlayScrollListener&&this.rightDiffOverlay&&(this.rightDiffOverlay.removeEventListener("scroll",this.rightOverlayScrollListener),this.rightOverlayScrollListener=null))}handleRightPanelEnter(){this.isEditModeEnabled||(this.rightHoverState="hovered",this.setOverlayLayer("right","hover"),this.setOverlayLayer("left","complete"),this.setOverlayScrollable("right",!1),this.setOverlayScrollable("left",!0),this.modifiedEditor&&this.leftDiffOverlay&&(this.rightTextareaScrollListener=e=>{let t=e.currentTarget;if(t&&this.ignoreNextScrollEventTargets.has(t)){this.ignoreNextScrollEventTargets.delete(t);return}this.leftDiffOverlay&&this.syncScrollByPercentage(this.modifiedEditor,this.leftDiffOverlay)},this.leftOverlayScrollListener=e=>{let t=e.currentTarget;if(t&&this.ignoreNextScrollEventTargets.has(t)){this.ignoreNextScrollEventTargets.delete(t);return}this.modifiedEditor&&this.syncScrollByPercentage(this.leftDiffOverlay,this.modifiedEditor)},this.modifiedEditor.addEventListener("scroll",this.rightTextareaScrollListener),this.leftDiffOverlay.addEventListener("scroll",this.leftOverlayScrollListener),requestAnimationFrame(()=>{this.modifiedEditor&&this.leftDiffOverlay&&(this.ensureScrollableSpace(this.modifiedEditor,this.leftDiffOverlay),this.originalEditor&&this.ensureScrollableSpace(this.originalEditor,this.leftDiffOverlay),this.syncScrollByPercentage(this.modifiedEditor,this.leftDiffOverlay))})))}handleRightPanelLeave(){this.isEditModeEnabled||(this.rightHoverState="default",this.setOverlayLayer("right","default"),this.setOverlayLayer("left","default"),this.setOverlayScrollable("left",!1),this.syncOverlayContentTransformToTextarea("left"),this.modifiedEditor&&this.restoreScrollableSpace(this.modifiedEditor),this.originalEditor&&this.restoreScrollableSpace(this.originalEditor),this.rightTextareaScrollListener&&this.modifiedEditor&&(this.modifiedEditor.removeEventListener("scroll",this.rightTextareaScrollListener),this.rightTextareaScrollListener=null),this.leftOverlayScrollListener&&this.leftDiffOverlay&&(this.leftDiffOverlay.removeEventListener("scroll",this.leftOverlayScrollListener),this.leftOverlayScrollListener=null))}syncDiffOverlayScroll(e,t){!e||!t||(t.scrollTop=e.scrollTop,t.scrollLeft=e.scrollLeft)}ignoreNextScrollEvent(e){this.ignoreNextScrollEventTargets.add(e),requestAnimationFrame(()=>{this.ignoreNextScrollEventTargets.delete(e)})}syncScrollByPercentage(e,t){if(!(!e||!t||this.isSyncingScroll)){this.isSyncingScroll=!0;try{let i=e.scrollHeight-e.clientHeight,r=i>0?e.scrollTop/i:0,l=t.scrollHeight-t.clientHeight,s=t.style.scrollBehavior;t.style.scrollBehavior="auto",this.ignoreNextScrollEvent(t),t.scrollTop=l*r,t.scrollLeft=e.scrollLeft,t.style.scrollBehavior=s}finally{this.isSyncingScroll=!1}}}ensureScrollableSpace(e,t){if(!e||!t)return;let i=window.getComputedStyle(e),r=e.dataset.originalPaddingBottom!==void 0?parseFloat(e.dataset.originalPaddingBottom):parseFloat(i.paddingBottom)||0,l=parseFloat(i.paddingBottom)||0,s=Math.max(0,l-r),a=e.scrollHeight-e.clientHeight-s,d=t.scrollHeight-t.clientHeight,h=Math.max(0,d-a);if(h===0){e.dataset.originalPaddingBottom!==void 0&&this.restoreScrollableSpace(e);return}if(e.dataset.originalPaddingBottom!==void 0&&h===s)return;e.dataset.originalPaddingBottom===void 0&&(e.dataset.originalPaddingBottom=String(r));let c=e.scrollTop;e.style.paddingBottom=`${r+h}px`;let g=e.scrollHeight-e.clientHeight;if(c>g){let v=e.style.scrollBehavior;e.style.scrollBehavior="auto",this.ignoreNextScrollEvent(e),e.scrollTop=g,e.style.scrollBehavior=v}}restoreScrollableSpace(e){if(!e||e.dataset.originalPaddingBottom===void 0)return;let t=parseFloat(e.dataset.originalPaddingBottom)||0,i=e.scrollTop;e.style.paddingBottom=`${t}px`,delete e.dataset.originalPaddingBottom;let r=e.scrollHeight-e.clientHeight;if(i>r){let l=e.style.scrollBehavior;e.style.scrollBehavior="auto",this.ignoreNextScrollEvent(e),e.scrollTop=r,e.style.scrollBehavior=l}}updateAllDiffViews(){this.isEditModeEnabled||(this.rebuildReadOnlyDiffCaches(),this.applyReadOnlyInteractionState(),requestAnimationFrame(()=>{this.leftHoverState==="hovered"&&this.originalEditor&&this.rightDiffOverlay&&(this.ensureScrollableSpace(this.originalEditor,this.rightDiffOverlay),this.modifiedEditor&&this.ensureScrollableSpace(this.modifiedEditor,this.rightDiffOverlay),this.syncScrollByPercentage(this.originalEditor,this.rightDiffOverlay)),this.rightHoverState==="hovered"&&this.modifiedEditor&&this.leftDiffOverlay&&(this.ensureScrollableSpace(this.modifiedEditor,this.leftDiffOverlay),this.originalEditor&&this.ensureScrollableSpace(this.originalEditor,this.leftDiffOverlay),this.syncScrollByPercentage(this.modifiedEditor,this.leftDiffOverlay))}))}addToHistory(e){this.historyIndex<this.history.length-1&&(this.history=this.history.slice(0,this.historyIndex+1)),this.history.push(e),this.historyIndex++,this.history.length>100&&(this.history.shift(),this.historyIndex--)}addHybridActions(e){let t=e.createEl("footer"),i=t.createDiv({cls:"footer-section"}),r=t.createDiv({cls:"footer-section"}),l=i.createDiv({cls:"toggle-wrapper",title:this.plugin.t("modal.toggle.editMode")});this.toggleEditModeWrapper=l,l.setAttribute("role","switch"),l.setAttribute("tabindex","0"),l.createDiv({cls:"toggle-switch"}),this.toggleEditModeLabelEl=l.createEl("span",{text:""}),this.syncEditModeToggleUI(),i.createDiv({cls:"divider"});let s=i.createDiv({cls:"segmented-control"}),a=(u,m)=>{let S=s.createEl("button",{text:this.plugin.t(m),cls:"segment-btn"});S.setAttribute("type","button"),S.setAttribute("aria-pressed","false"),S.dataset.mode=u,S.addEventListener("click",()=>this.setDiffGranularity(u)),this.diffGranularityBtnEls[u]=S};a("word","modal.diffGranularity.word"),a("char","modal.diffGranularity.char"),this.updateDiffGranularityUI(),i.createDiv({cls:"divider"});let d=i.createDiv({cls:"hybrid-font-controls"}),h=d.createEl("button",{cls:"btn btn-ghost hybrid-font-btn"});(0,L.setIcon)(h,"minus"),h.setAttribute("aria-label",this.plugin.t("modal.fontSize.decreaseAriaLabel")),h.setAttribute("title",this.plugin.t("modal.fontSize.decreaseAriaLabel")),this.fontDisplayEl=d.createEl("span",{text:"A",cls:"hybrid-font-display"}),this.fontDisplayEl.style.fontSize=`${this.fontSize}px`,this.fontDisplayEl.setAttribute("title",`${this.fontSize}px`);let c=d.createEl("button",{cls:"btn btn-ghost hybrid-font-btn"});(0,L.setIcon)(c,"plus"),c.setAttribute("aria-label",this.plugin.t("modal.fontSize.increaseAriaLabel")),c.setAttribute("title",this.plugin.t("modal.fontSize.increaseAriaLabel"));let g=r.createEl("button",{cls:"btn btn-ghost hybrid-clear-btn"});g.setAttribute("type","button"),g.textContent=this.plugin.t("modal.action.clear"),r.createDiv({cls:"divider"});let v=r.createEl("button",{text:this.plugin.t("modal.action.cancel"),cls:"btn btn-secondary hybrid-cancel-btn"});v.setAttribute("type","button");let p=r.createEl("button",{cls:"btn btn-primary hybrid-apply-btn"});p.setAttribute("type","button");let y=p.createSpan({cls:"btn-icon",attr:{"aria-hidden":"true"}});(0,L.setIcon)(y,"check"),p.appendText(this.plugin.t("modal.action.apply"));let f=()=>this.setEditModeEnabled(!this.isEditModeEnabled);l.addEventListener("click",f),l.addEventListener("keydown",u=>{(u.key==="Enter"||u.key===" "||u.key==="Spacebar")&&(u.preventDefault(),f())}),g.addEventListener("click",()=>{this.finalEditor&&(this.finalEditor.value="",this.finalEditor.dispatchEvent(new Event("input",{bubbles:!0})),this.syncFinalEditorMirror())}),p.addEventListener("click",()=>{this.finalEditor&&(this.onApply(this.finalEditor.value),this.close())}),v.addEventListener("click",()=>{this.close()}),h.addEventListener("click",()=>{let u=Math.max(10,this.fontSize-1);this.updateFontSize(u)}),c.addEventListener("click",()=>{let u=Math.min(24,this.fontSize+1);this.updateFontSize(u)})}updateDiffGranularityUI(){let e=["word","char"];for(let t of e){let i=this.diffGranularityBtnEls[t];if(!i)continue;let r=t===this.diffGranularity;i.classList.toggle("is-active",r),i.setAttribute("aria-pressed",r?"true":"false")}}setDiffGranularity(e){e!==this.diffGranularity&&(this.diffGranularity=e,this.updateDiffGranularityUI(),this.updateAllDiffViews(),this.plugin.ui.diffGranularity=e,this.plugin.saveUiState())}copyFromOriginal(){if(!this.originalEditor||!this.finalEditor)return;let e=this.getSelectedText(this.originalEditor);e?this.insertAtCursor(this.finalEditor,e):new L.Notice(this.plugin.t("modal.notice.selectTextInOriginal"))}copyFromModified(){if(!this.modifiedEditor||!this.finalEditor)return;let e=this.getSelectedText(this.modifiedEditor);e?this.insertAtCursor(this.finalEditor,e):new L.Notice(this.plugin.t("modal.notice.selectTextInModified"))}copyAllModified(){if(!this.modifiedEditor||!this.finalEditor)return;let e=this.modifiedEditor.value;e?(this.finalEditor.value=e,new L.Notice(this.plugin.t("modal.notice.copied"))):new L.Notice(this.plugin.t("modal.notice.modifiedEmpty"))}getSelectedText(e){let t=e.selectionStart,i=e.selectionEnd;return t===i?"":e.value.substring(t,i)}insertAtCursor(e,t){var f,u;if(e.tagName!=="TEXTAREA")return;let i=e.scrollTop,r=(f=e.selectionStart)!=null?f:0,l=(u=e.selectionEnd)!=null?u:0,s=e.value.substring(0,r),a=e.value.substring(l),d=document.activeElement===e,h=s+t+a;e.value=h;let c=e.value,g=Math.max(0,c.length-s.length-a.length),v=s.length,p=v+g;d&&e.focus(),this.flashCopiedRange(e,v,p),e.scrollTop=i;let y=new Event("input",{bubbles:!0});e.dispatchEvent(y),this.syncFinalEditorMirror()}flashCopiedRange(e,t,i){t!==i&&(e===this.finalEditor&&(this.finalEditorFlashRange={start:t,end:i}),e.setSelectionRange(t,i),this.copyFlashTimer&&clearTimeout(this.copyFlashTimer),this.copyFlashTimer=setTimeout(()=>{e.selectionStart===t&&e.selectionEnd===i&&e.setSelectionRange(i,i),e===this.finalEditor&&(this.finalEditorFlashRange=null)},600))}addKeyboardShortcuts(){this.boundHandleKeyDown||(this.boundHandleKeyDown=this.handleKeyDown.bind(this)),document.addEventListener("keydown",this.boundHandleKeyDown,{capture:!0})}handleKeyDown(e){let t=document.activeElement,i=t?this.modalEl.contains(t):!1,r=document.documentElement;if(!(!i&&t!==document.body&&t!==r&&t!==null)&&(e.key==="Enter"||e.key==="Return"||e.keyCode===13)){if(t===this.finalEditor||this.isEditModeEnabled)return;if(e.preventDefault(),t===this.originalEditor){(this.originalEditor?this.getSelectedText(this.originalEditor):"")?(this.copyFromOriginal(),this.originalEditor&&this.originalEditor.setSelectionRange(this.originalEditor.selectionEnd,this.originalEditor.selectionEnd)):new L.Notice(this.plugin.t("modal.notice.selectTextInOriginal"));return}if(t===this.modifiedEditor){(this.modifiedEditor?this.getSelectedText(this.modifiedEditor):"")?(this.copyFromModified(),this.modifiedEditor&&this.modifiedEditor.setSelectionRange(this.modifiedEditor.selectionEnd,this.modifiedEditor.selectionEnd)):new L.Notice(this.plugin.t("modal.notice.selectTextInModified"));return}}}onClose(){if(this.boundSyncFinalEditorMirror&&this.finalEditor){let e=this.boundSyncFinalEditorMirror;this.finalEditor.removeEventListener("input",e),this.finalEditor.removeEventListener("select",e),this.finalEditor.removeEventListener("keyup",e),this.finalEditor.removeEventListener("mouseup",e),this.finalEditor.removeEventListener("scroll",e),this.boundSyncFinalEditorMirror=null}this.boundFinalEditorBeforeInput&&this.finalEditor&&(this.finalEditor.removeEventListener("beforeinput",this.boundFinalEditorBeforeInput,!0),this.boundFinalEditorBeforeInput=null),this.boundSyncFinalEditorMirrorFocusIn&&(this.modalEl.removeEventListener("focusin",this.boundSyncFinalEditorMirrorFocusIn,!0),this.boundSyncFinalEditorMirrorFocusIn=null),this.boundSyncFinalEditorMirrorFocusOut&&(this.modalEl.removeEventListener("focusout",this.boundSyncFinalEditorMirrorFocusOut,!0),this.boundSyncFinalEditorMirrorFocusOut=null),this.boundHandleKeyDown&&(document.removeEventListener("keydown",this.boundHandleKeyDown,{capture:!0}),this.boundHandleKeyDown=null),this.copyFlashTimer&&(clearTimeout(this.copyFlashTimer),this.copyFlashTimer=null),this.leftDiffOverlay=null,this.rightDiffOverlay=null,this.leftDiffLayers=null,this.rightDiffLayers=null,this.contentEl.empty()}updateFontSize(e){this.fontSize=e,this.modalEl.style.setProperty("--hybrid-font-size",`${e}px`),this.syncFinalEditorMirrorStyles(),this.syncFinalEditorMirror(),this.fontDisplayEl&&(this.fontDisplayEl.style.fontSize=`${e}px`,this.fontDisplayEl.setAttribute("title",`${e}px`)),this.plugin.ui.fontSize=e,this.plugin.saveUiState(),this.syncOverlayContentTransformToTextarea("left"),this.syncOverlayContentTransformToTextarea("right"),requestAnimationFrame(()=>{this.leftHoverState==="hovered"&&this.originalEditor&&this.rightDiffOverlay&&(this.ensureScrollableSpace(this.originalEditor,this.rightDiffOverlay),this.syncScrollByPercentage(this.originalEditor,this.rightDiffOverlay)),this.rightHoverState==="hovered"&&this.modifiedEditor&&this.leftDiffOverlay&&(this.ensureScrollableSpace(this.modifiedEditor,this.leftDiffOverlay),this.syncScrollByPercentage(this.modifiedEditor,this.leftDiffOverlay))})}syncEditModeToggleUI(){this.toggleEditModeWrapper&&(this.toggleEditModeWrapper.classList.toggle("is-enabled",this.isEditModeEnabled),this.toggleEditModeWrapper.setAttribute("aria-checked",this.isEditModeEnabled?"true":"false")),this.toggleEditModeLabelEl&&(this.toggleEditModeLabelEl.textContent=this.plugin.t("modal.toggle.editMode"))}setEditModeEnabled(e){if(e===this.isEditModeEnabled){this.syncEditModeToggleUI();return}this.isEditModeEnabled=e,this.syncEditModeToggleUI(),this.modalEl.classList.toggle("is-edit-mode",this.isEditModeEnabled),this.originalEditor&&(this.originalEditor.readOnly=!this.isEditModeEnabled),this.modifiedEditor&&(this.modifiedEditor.readOnly=!this.isEditModeEnabled),this.isEditModeEnabled&&(this.leftHoverState="default",this.rightHoverState="default",this.setOverlayScrollable("left",!1),this.setOverlayScrollable("right",!1),this.syncOverlayContentTransformToTextarea("left"),this.syncOverlayContentTransformToTextarea("right"),this.originalEditor&&this.restoreScrollableSpace(this.originalEditor),this.modifiedEditor&&this.restoreScrollableSpace(this.modifiedEditor),this.leftTextareaScrollListener&&this.originalEditor&&(this.originalEditor.removeEventListener("scroll",this.leftTextareaScrollListener),this.leftTextareaScrollListener=null),this.rightOverlayScrollListener&&this.rightDiffOverlay&&(this.rightDiffOverlay.removeEventListener("scroll",this.rightOverlayScrollListener),this.rightOverlayScrollListener=null),this.rightTextareaScrollListener&&this.modifiedEditor&&(this.modifiedEditor.removeEventListener("scroll",this.rightTextareaScrollListener),this.rightTextareaScrollListener=null),this.leftOverlayScrollListener&&this.leftDiffOverlay&&(this.leftDiffOverlay.removeEventListener("scroll",this.leftOverlayScrollListener),this.leftOverlayScrollListener=null)),this.updateAllDiffViews()}toggleEditMode(){this.setEditModeEnabled(!this.isEditModeEnabled)}createInlineDiffOverlay(e){let t=e.createDiv({cls:"diff-inline-overlay"});t.dataset.layered="true",t.dataset.activeLayer="default";let i=t.createDiv({cls:"diff-inline-content",attr:{"data-layer":"default"}}),r=t.createDiv({cls:"diff-inline-content",attr:{"data-layer":"hover"}}),l=t.createDiv({cls:"diff-inline-content",attr:{"data-layer":"complete"}});return i.dataset.layer="default",r.dataset.layer="hover",l.dataset.layer="complete",{overlay:t,defaultContent:i,hoverContent:r,completeContent:l}}getOverlay(e){return e==="left"?this.leftDiffOverlay:this.rightDiffOverlay}getOverlayLayers(e){return e==="left"?this.leftDiffLayers:this.rightDiffLayers}setOverlayLayer(e,t){let i=this.getOverlay(e);i&&(i.dataset.activeLayer=t)}setOverlayScrollable(e,t){let i=this.getOverlay(e);if(i){if(t){i.addClass("scrollable"),this.setOverlayContentTransform(e,"none");return}if(i.classList.contains("scrollable")){let r=e==="left"?this.originalEditor:this.modifiedEditor;this.isSyncingScroll=!0;try{if(r){let s=i.scrollHeight-i.clientHeight,a=s>0?i.scrollTop/s:0,d=Math.max(0,Math.min(1,a)),h=r.scrollHeight-r.clientHeight,c=r.style.scrollBehavior;r.style.scrollBehavior="auto",this.ignoreNextScrollEvent(r),r.scrollTop=h*d,r.scrollLeft=i.scrollLeft,r.style.scrollBehavior=c}let l=i.style.scrollBehavior;i.style.scrollBehavior="auto",this.ignoreNextScrollEvent(i),i.scrollTop=0,i.scrollLeft=0,i.style.scrollBehavior=l}finally{this.isSyncingScroll=!1}}i.removeClass("scrollable"),this.syncOverlayContentTransformToTextarea(e)}}setOverlayContentTransform(e,t){let i=this.getOverlayLayers(e);if(!i)return;let r=[i.default,i.hover,i.complete];for(let l of r)l&&(l.style.transform=t)}syncOverlayContentTransformToTextarea(e){let t=this.getOverlay(e);if(!t||t.classList.contains("scrollable"))return;let i=e==="left"?this.originalEditor:this.modifiedEditor;if(!i)return;let r=`translate(-${i.scrollLeft}px, -${i.scrollTop}px)`;this.setOverlayContentTransform(e,r)}applyReadOnlyInteractionState(){if(!this.isEditModeEnabled){if(this.leftHoverState==="hovered"){this.setOverlayLayer("left","hover"),this.setOverlayLayer("right","complete"),this.setOverlayScrollable("left",!1),this.setOverlayScrollable("right",!0);return}if(this.rightHoverState==="hovered"){this.setOverlayLayer("right","hover"),this.setOverlayLayer("left","complete"),this.setOverlayScrollable("right",!1),this.setOverlayScrollable("left",!0);return}this.setOverlayLayer("left","default"),this.setOverlayLayer("right","default"),this.setOverlayScrollable("left",!1),this.setOverlayScrollable("right",!1)}}countParagraphs(e){return e.trim()?e.split(/\n\s*\n/).filter(i=>i.trim().length>0).length:0}findParagraphBreakPositions(e){let t=[],i=/\n\s*\n/g,r;for(;(r=i.exec(e))!==null;)t.push(r.index);return t}getSuperscriptNumber(e){let t=["\u2070","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079"];return e<=0?"":e<10?t[e]:String(e).split("").map(i=>t[parseInt(i)]).join("")}createParagraphMarker(e,t){let i=e.createSpan({cls:"diff-paragraph-marker"}),r=i.createSpan({cls:"diff-paragraph-marker-dot"});r.textContent="\u25CF";let l=i.createSpan({cls:"diff-paragraph-marker-num"});l.textContent=this.getSuperscriptNumber(t)}calculateParagraphMarkers(e,t,i){let r=this.countParagraphs(e),l=this.countParagraphs(t),s,a,d;if(l>r)s="right",a=t,d=this.findParagraphBreakPositions(t);else if(r>l)s="left",a=e,d=this.findParagraphBreakPositions(e);else return{moreParagraphsSide:"equal",markers:[]};let h=[],c=0,g=0,v=1,p=0;for(let y of i){let f=y.value.length;if(y.removed){if(s==="left")for(;p<d.length;){let u=d[p];if(u>c&&u<=c+f)h.push({number:v++,leftPos:u,rightPos:g}),p++;else break}c+=f}else if(y.added){if(s==="right")for(;p<d.length;){let u=d[p];if(u>g&&u<=g+f)h.push({number:v++,leftPos:c,rightPos:u}),p++;else break}g+=f}else{if(s==="left")for(;p<d.length;){let u=d[p];if(u>c&&u<=c+f){let m=u-c;h.push({number:v++,leftPos:u,rightPos:g+m}),p++}else break}else if(s==="right")for(;p<d.length;){let u=d[p];if(u>g&&u<=g+f){let m=u-g;h.push({number:v++,leftPos:c+m,rightPos:u}),p++}else break}c+=f,g+=f}}return{moreParagraphsSide:s,markers:h}}rebuildReadOnlyDiffCaches(){if(this.isEditModeEnabled)return;let e=this.leftDiffLayers,t=this.rightDiffLayers;if(!(e!=null&&e.default)||!e.hover||!e.complete||!(t!=null&&t.default)||!t.hover||!t.complete)return;let i=this.originalEditor?this.originalEditor.value:this.originalText,r=this.modifiedEditor?this.modifiedEditor.value:this.modifiedText,l=this.diffInlineText(i,r),{moreParagraphsSide:s,markers:a}=this.calculateParagraphMarkers(i,r,l),d=new Map,h=new Map;for(let f of a)d.set(f.leftPos,f.number),h.set(f.rightPos,f.number);e.default.textContent="",e.hover.textContent="",e.complete.textContent="",t.default.textContent="",t.hover.textContent="",t.complete.textContent="";let c=0,g=0,v=(f,u,m,S,E)=>{let b=m,T=0;for(;T<u.length;){let x=S.get(b);x!==void 0&&this.createParagraphMarker(f,x);let w=u.length;for(let[M]of S)if(M>b&&M<m+u.length){let N=M-m;N<w&&N>T&&(w=N)}let O=u.slice(T,w);if(O){let M=f.createSpan();M.textContent=O,E&&M.addClass(E)}T=w,b=m+T}},p=(f,u,m)=>{let S=f.createSpan();S.textContent=u,m&&S.addClass(m)},y=s==="right"?h:d;for(let f of l){let u=f.value.length;f.added||v(e.default,f.value,c,d,f.removed?"diff-deleted-default":void 0),f.removed||v(t.default,f.value,g,h,f.added?"diff-added-default":void 0),f.added||v(e.hover,f.value,c,d,f.removed?"diff-deleted-hover":void 0),f.removed||v(t.hover,f.value,g,h,f.added?"diff-added-hover":void 0);let m=f.removed?"diff-deleted-complete":f.added?"diff-added-complete":void 0;s==="right"?f.removed?(p(e.complete,f.value,m),p(t.complete,f.value,m)):(v(e.complete,f.value,g,y,m),v(t.complete,f.value,g,y,m)):s==="left"?f.added?(p(e.complete,f.value,m),p(t.complete,f.value,m)):(v(e.complete,f.value,c,y,m),v(t.complete,f.value,c,y,m)):(p(e.complete,f.value,m),p(t.complete,f.value,m)),f.added||(c+=u),f.removed||(g+=u)}}};var Y={fontSize:14,diffGranularity:"word"},I=class extends A.Plugin{constructor(){super(...arguments);this.ui={...Y};this.pluginData={}}t(e){return k(e)}async onload(){await this.loadUiState(),this.addCommand({id:"diff-apply-hybrid",name:this.t("command.hybrid.name"),editorCallback:e=>this.openHybridDiffForSelection(e)}),this.registerEvent(this.app.workspace.on("editor-menu",(e,t)=>{let i=t.getSelection();i&&i.length>0&&e.addItem(r=>r.setTitle(this.t("menu.hybrid.title")).setIcon("edit").onClick(()=>this.openHybridDiffForSelection(t)))}))}async loadUiState(){var r;let e=await this.loadData();this.pluginData=e!=null?e:{};let t=(r=this.pluginData.ui)!=null?r:{},i=t.diffGranularity==="char"?"char":"word";this.ui={...Y,...t,diffGranularity:i}}async saveUiState(){this.pluginData={...this.pluginData,ui:this.ui},await this.saveData(this.pluginData)}async openHybridDiffForSelection(e){let t=e.getSelection();if(!t||t.length===0){new A.Notice(this.t("notice.selectOriginalSegment"));return}let i="";try{i=await navigator.clipboard.readText()}catch(a){console.warn(this.t("notice.clipboardReadFailed"),a)}let r=e.getCursor("from"),l=e.getCursor("to");new P(this.app,{originalText:t,modifiedText:i,onApply:a=>{e.replaceRange(a,r,l)},fontSize:this.ui.fontSize,diffGranularity:this.ui.diffGranularity,plugin:this}).open()}};
