"use strict";var z=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var ee=Object.prototype.hasOwnProperty;var te=(l,r)=>{for(var e in r)z(l,e,{get:r[e],enumerable:!0})},ie=(l,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of _(r))!ee.call(l,i)&&i!==e&&z(l,i,{get:()=>r[i],enumerable:!(t=Y(r,i))||t.enumerable});return l};var ne=l=>ie(z({},"__esModule",{value:!0}),l);var he={};te(he,{default:()=>H});module.exports=ne(he);var A=require("obsidian");var M=require("obsidian"),W={"command.hybrid.name":"Hybrid edit selection","menu.hybrid.title":"Hybrid Edit (Hybrid Diff)","notice.selectOriginalSegment":"Select the original text in the note first.","notice.clipboardReadFailed":"Failed to read clipboard content (permission?).","modal.header.original":"Original","modal.header.editor":"Editor","modal.header.modified":"Modified","modal.toggle.readOnly":"Read Only","modal.toggle.editMode":"Edit Mode","modal.action.clear":"Clear","modal.action.apply":"Apply","modal.action.cancel":"Cancel","modal.fontSize.label":"Size:","modal.fontSize.decreaseAriaLabel":"Decrease font size","modal.fontSize.increaseAriaLabel":"Increase font size","modal.notice.readOnly":"Read Only","modal.notice.editMode":"Edit Mode","modal.notice.selectTextInOriginal":"Select text in Original to copy first.","modal.notice.selectTextInModified":"Select text in Modified to copy first.","modal.notice.copied":"Copied.","modal.notice.modifiedEmpty":"Modified version is empty.","settings.title":"Diff Apply Settings","settings.language.name":"Language","settings.language.desc":"Use Obsidian app language, or force a specific language.","settings.language.option.auto":"Auto","settings.language.option.en":"English","settings.language.option.zh":"\u4E2D\u6587","settings.fontSize.name":"Font size","settings.fontSize.desc":"Set the editor font size (px).","settings.diffStyle.default.name":"Default diff display","settings.diffStyle.default.desc":"How differences look when not hovering a panel.","settings.diffStyle.complete.name":"Complete diff display","settings.diffStyle.complete.desc":"How differences look in the full comparison view on hover.","settings.diffStyle.option.background":"Background highlight","settings.diffStyle.option.text":"Text color only","settings.diffStyle.option.underline":"Underline only","settings.diffColor.added.name":"Added color","settings.diffColor.deleted.name":"Deleted color","settings.diffOpacity.default.name":"Default highlight opacity","settings.diffOpacity.default.desc":"Background opacity in default state (0\u201340%).","settings.diffOpacity.complete.name":"Complete highlight opacity","settings.diffOpacity.complete.desc":"Background opacity in complete view (0\u201340%).","settings.smartDblClickInsertNewlines.name":"Double-click copy: smart newlines","settings.smartDblClickInsertNewlines.desc":"When double-clicking a line to copy into the editor in Read Only mode: if the source previous line is blank (or whitespace), insert at least 2 newlines before content; otherwise at least 1. Only applies when the editor is non-empty and the cursor is not inside a line.","settings.shortcuts.title":"Shortcuts","settings.shortcuts.enter":"Enter : copy selection to editor","settings.shortcuts.dblClick":"Double-click any non-empty line in read-only panel: copy line to editor","settings.shortcuts.undo":"Cmd/Ctrl + Z : undo"},re={"command.hybrid.name":"\u6DF7\u5408\u7F16\u8F91\u6240\u9009\u6587\u672C","menu.hybrid.title":"\u6DF7\u5408\u7F16\u8F91\uFF08Hybrid Diff\uFF09","notice.selectOriginalSegment":"\u8BF7\u5148\u5728\u7B14\u8BB0\u4E2D\u9009\u4E2D\u8981\u5BF9\u6BD4\u7684\u539F\u6587\u7247\u6BB5\u3002","notice.clipboardReadFailed":"\u65E0\u6CD5\u8BFB\u53D6\u526A\u8D34\u677F\u5185\u5BB9\uFF0C\u53EF\u80FD\u662F\u6743\u9650\u95EE\u9898\u3002","modal.header.original":"\u539F\u6587","modal.header.editor":"\u7F16\u8F91\u5668","modal.header.modified":"\u4FEE\u6539\u7248","modal.toggle.readOnly":"\u53EA\u8BFB","modal.toggle.editMode":"\u7F16\u8F91","modal.action.clear":"\u6E05\u7A7A","modal.action.apply":"\u5E94\u7528","modal.action.cancel":"\u53D6\u6D88","modal.fontSize.label":"\u5B57\u53F7\uFF1A","modal.fontSize.decreaseAriaLabel":"\u51CF\u5C0F\u5B57\u53F7","modal.fontSize.increaseAriaLabel":"\u589E\u5927\u5B57\u53F7","modal.notice.readOnly":"\u53EA\u8BFB\u6A21\u5F0F","modal.notice.editMode":"\u7F16\u8F91\u6A21\u5F0F","modal.notice.selectTextInOriginal":"\u8BF7\u5148\u5728\u539F\u6587\u4E2D\u9009\u62E9\u8981\u590D\u5236\u7684\u6587\u672C","modal.notice.selectTextInModified":"\u8BF7\u5148\u5728\u4FEE\u6539\u7248\u4E2D\u9009\u62E9\u8981\u590D\u5236\u7684\u6587\u672C","modal.notice.copied":"\u5DF2\u590D\u5236\u3002","modal.notice.modifiedEmpty":"\u4FEE\u6539\u7248\u4E3A\u7A7A\u3002","settings.title":"Diff Apply \u63D2\u4EF6\u8BBE\u7F6E","settings.language.name":"\u8BED\u8A00","settings.language.desc":"\u8DDF\u968F Obsidian \u5E94\u7528\u8BED\u8A00\uFF0C\u6216\u624B\u52A8\u6307\u5B9A\u8BED\u8A00\u3002","settings.language.option.auto":"\u81EA\u52A8","settings.language.option.en":"English","settings.language.option.zh":"\u4E2D\u6587","settings.fontSize.name":"\u5B57\u4F53\u5927\u5C0F","settings.fontSize.desc":"\u8BBE\u7F6E\u7F16\u8F91\u5668\u4E2D\u7684\u5B57\u4F53\u5927\u5C0F\uFF08\u50CF\u7D20\uFF09","settings.diffStyle.default.name":"\u9ED8\u8BA4\u5DEE\u5F02\u663E\u793A","settings.diffStyle.default.desc":"\u672A\u60AC\u505C\u65F6\u7684\u5DEE\u5F02\u663E\u793A\u65B9\u5F0F\u3002","settings.diffStyle.complete.name":"\u5B8C\u6574\u5DEE\u5F02\u663E\u793A","settings.diffStyle.complete.desc":"\u60AC\u505C\u5BF9\u6BD4\u65F6\u5B8C\u6574\u5DEE\u5F02\u7684\u663E\u793A\u65B9\u5F0F\u3002","settings.diffStyle.option.background":"\u80CC\u666F\u9AD8\u4EAE","settings.diffStyle.option.text":"\u4EC5\u6587\u5B57\u989C\u8272","settings.diffStyle.option.underline":"\u4EC5\u4E0B\u5212\u7EBF","settings.diffColor.added.name":"\u65B0\u589E\u989C\u8272","settings.diffColor.deleted.name":"\u5220\u9664\u989C\u8272","settings.diffOpacity.default.name":"\u9ED8\u8BA4\u9AD8\u4EAE\u900F\u660E\u5EA6","settings.diffOpacity.default.desc":"\u9ED8\u8BA4\u72B6\u6001\u4E0B\u80CC\u666F\u900F\u660E\u5EA6\uFF080\u201340%\uFF09\u3002","settings.diffOpacity.complete.name":"\u5B8C\u6574\u9AD8\u4EAE\u900F\u660E\u5EA6","settings.diffOpacity.complete.desc":"\u5B8C\u6574\u89C6\u56FE\u4E0B\u80CC\u666F\u900F\u660E\u5EA6\uFF080\u201340%\uFF09\u3002","settings.smartDblClickInsertNewlines.name":"\u53CC\u51FB\u884C\u590D\u5236\uFF1A\u667A\u80FD\u8865\u6362\u884C","settings.smartDblClickInsertNewlines.desc":"Read Only \u4E0B\u53CC\u51FB\u590D\u5236\u884C\u5230 Editor \u65F6\uFF1A\u5982\u679C\u6E90\u6587\u672C\u4E0A\u4E00\u884C\u4E3A\u7A7A\uFF08\u6216\u4EC5\u7A7A\u767D\uFF09\u5219\u5728\u63D2\u5165\u5185\u5BB9\u524D\u8865\u5230\u81F3\u5C11 2 \u4E2A\u6362\u884C\uFF1B\u5426\u5219\u8865\u5230\u81F3\u5C11 1 \u4E2A\u3002\u4EC5\u5728 Editor \u975E\u7A7A\u3001\u4E14\u5149\u6807\u4E0D\u5728\u884C\u5185\u65F6\u751F\u6548\u3002","settings.shortcuts.title":"\u5FEB\u6377\u952E\u8BF4\u660E","settings.shortcuts.enter":"Enter : \u590D\u5236\u9009\u4E2D\u6587\u672C\u5230\u7F16\u8F91\u5668","settings.shortcuts.dblClick":"\u53CC\u51FB\u53EA\u8BFB\u680F\u4EFB\u610F\u975E\u7A7A\u884C\uFF1A\u590D\u5236\u8BE5\u884C\u5230\u7F16\u8F91\u5668","settings.shortcuts.undo":"Cmd/Ctrl + Z : \u64A4\u9500\u7F16\u8F91"};function le(){let l=M.getLanguage;if(typeof l=="function")try{return l()}catch(r){}return M.moment.locale()}function oe(l){return l==="en"||l==="zh"?l:le().toLowerCase().startsWith("zh")?"zh":"en"}function V(l,r){var i,n;return(n=(i=(oe(r)==="zh"?re:W)[l])!=null?i:W[l])!=null?n:l}var m=require("obsidian"),T=class extends m.PluginSettingTab{constructor(r,e){super(r,e),this.plugin=e}display(){let{containerEl:r}=this;r.empty(),r.createEl("h2",{text:this.plugin.t("settings.title")}),new m.Setting(r).setName(this.plugin.t("settings.language.name")).setDesc(this.plugin.t("settings.language.desc")).addDropdown(t=>t.addOption("auto",this.plugin.t("settings.language.option.auto")).addOption("en",this.plugin.t("settings.language.option.en")).addOption("zh",this.plugin.t("settings.language.option.zh")).setValue(this.plugin.settings.language).onChange(async i=>{this.plugin.settings.language=i,await this.plugin.saveSettings(),this.display()})),new m.Setting(r).setName(this.plugin.t("settings.fontSize.name")).setDesc(this.plugin.t("settings.fontSize.desc")).addSlider(t=>t.setLimits(10,24,1).setValue(this.plugin.settings.fontSize).setDynamicTooltip().onChange(async i=>{this.plugin.settings.fontSize=i,await this.plugin.saveSettings()})),new m.Setting(r).setName(this.plugin.t("settings.diffStyle.default.name")).setDesc(this.plugin.t("settings.diffStyle.default.desc")).addDropdown(t=>t.addOption("background",this.plugin.t("settings.diffStyle.option.background")).addOption("text",this.plugin.t("settings.diffStyle.option.text")).addOption("underline",this.plugin.t("settings.diffStyle.option.underline")).setValue(this.plugin.settings.defaultDiffStyle).onChange(async i=>{this.plugin.settings.defaultDiffStyle=i,await this.plugin.saveSettings()})),new m.Setting(r).setName(this.plugin.t("settings.diffStyle.complete.name")).setDesc(this.plugin.t("settings.diffStyle.complete.desc")).addDropdown(t=>t.addOption("background",this.plugin.t("settings.diffStyle.option.background")).addOption("text",this.plugin.t("settings.diffStyle.option.text")).addOption("underline",this.plugin.t("settings.diffStyle.option.underline")).setValue(this.plugin.settings.completeDiffStyle).onChange(async i=>{this.plugin.settings.completeDiffStyle=i,await this.plugin.saveSettings()})),new m.Setting(r).setName(this.plugin.t("settings.diffColor.added.name")).addColorPicker(t=>t.setValue(this.plugin.settings.diffAddedColor).onChange(async i=>{this.plugin.settings.diffAddedColor=i,await this.plugin.saveSettings()})),new m.Setting(r).setName(this.plugin.t("settings.diffColor.deleted.name")).addColorPicker(t=>t.setValue(this.plugin.settings.diffDeletedColor).onChange(async i=>{this.plugin.settings.diffDeletedColor=i,await this.plugin.saveSettings()})),new m.Setting(r).setName(this.plugin.t("settings.diffOpacity.default.name")).setDesc(this.plugin.t("settings.diffOpacity.default.desc")).addSlider(t=>t.setLimits(0,40,1).setValue(this.plugin.settings.diffDefaultOpacity).setDynamicTooltip().onChange(async i=>{this.plugin.settings.diffDefaultOpacity=i,await this.plugin.saveSettings()})),new m.Setting(r).setName(this.plugin.t("settings.diffOpacity.complete.name")).setDesc(this.plugin.t("settings.diffOpacity.complete.desc")).addSlider(t=>t.setLimits(0,40,1).setValue(this.plugin.settings.diffCompleteOpacity).setDynamicTooltip().onChange(async i=>{this.plugin.settings.diffCompleteOpacity=i,await this.plugin.saveSettings()})),new m.Setting(r).setName(this.plugin.t("settings.smartDblClickInsertNewlines.name")).setDesc(this.plugin.t("settings.smartDblClickInsertNewlines.desc")).addToggle(t=>t.setValue(this.plugin.settings.smartDblClickInsertNewlines).onChange(async i=>{this.plugin.settings.smartDblClickInsertNewlines=i,await this.plugin.saveSettings()})),r.createEl("h3",{text:this.plugin.t("settings.shortcuts.title")});let e=r.createEl("ul");e.createEl("li",{text:this.plugin.t("settings.shortcuts.enter")}),e.createEl("li",{text:this.plugin.t("settings.shortcuts.dblClick")}),e.createEl("li",{text:this.plugin.t("settings.shortcuts.undo")})}};var v=require("obsidian");function E(){}E.prototype={diff:function(r,e){var t,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},n=i.callback;typeof i=="function"&&(n=i,i={}),this.options=i;var o=this;function s(g){return n?(setTimeout(function(){n(void 0,g)},0),!0):g}r=this.castInput(r),e=this.castInput(e),r=this.removeEmpty(this.tokenize(r)),e=this.removeEmpty(this.tokenize(e));var a=e.length,d=r.length,c=1,f=a+d;i.maxEditLength&&(f=Math.min(f,i.maxEditLength));var u=(t=i.timeout)!==null&&t!==void 0?t:1/0,p=Date.now()+u,h=[{oldPos:-1,lastComponent:void 0}],y=this.extractCommon(h[0],e,r,0);if(h[0].oldPos+1>=d&&y+1>=a)return s([{value:this.join(e),count:e.length}]);var L=-1/0,D=1/0;function k(){for(var g=Math.max(L,-c);g<=Math.min(D,c);g+=2){var b=void 0,w=h[g-1],x=h[g+1];w&&(h[g-1]=void 0);var I=!1;if(x){var $=x.oldPos-g;I=x&&0<=$&&$<a}var K=w&&w.oldPos+1<d;if(!I&&!K){h[g]=void 0;continue}if(!K||I&&w.oldPos+1<x.oldPos?b=o.addToPath(x,!0,void 0,0):b=o.addToPath(w,void 0,!0,1),y=o.extractCommon(b,e,r,g),b.oldPos+1>=d&&y+1>=a)return s(se(o,b.lastComponent,e,r,o.useLongestToken));h[g]=b,b.oldPos+1>=d&&(D=Math.min(D,g-1)),y+1>=a&&(L=Math.max(L,g+1))}c++}if(n)(function g(){setTimeout(function(){if(c>f||Date.now()>p)return n();k()||g()},0)})();else for(;c<=f&&Date.now()<=p;){var B=k();if(B)return B}},addToPath:function(r,e,t,i){var n=r.lastComponent;return n&&n.added===e&&n.removed===t?{oldPos:r.oldPos+i,lastComponent:{count:n.count+1,added:e,removed:t,previousComponent:n.previousComponent}}:{oldPos:r.oldPos+i,lastComponent:{count:1,added:e,removed:t,previousComponent:n}}},extractCommon:function(r,e,t,i){for(var n=e.length,o=t.length,s=r.oldPos,a=s-i,d=0;a+1<n&&s+1<o&&this.equals(e[a+1],t[s+1]);)a++,s++,d++;return d&&(r.lastComponent={count:d,previousComponent:r.lastComponent}),r.oldPos=s,a},equals:function(r,e){return this.options.comparator?this.options.comparator(r,e):r===e||this.options.ignoreCase&&r.toLowerCase()===e.toLowerCase()},removeEmpty:function(r){for(var e=[],t=0;t<r.length;t++)r[t]&&e.push(r[t]);return e},castInput:function(r){return r},tokenize:function(r){return r.split("")},join:function(r){return r.join("")}};function se(l,r,e,t,i){for(var n=[],o;r;)n.push(r),o=r.previousComponent,delete r.previousComponent,r=o;n.reverse();for(var s=0,a=n.length,d=0,c=0;s<a;s++){var f=n[s];if(f.removed){if(f.value=l.join(t.slice(c,c+f.count)),c+=f.count,s&&n[s-1].added){var p=n[s-1];n[s-1]=n[s],n[s]=p}}else{if(!f.added&&i){var u=e.slice(d,d+f.count);u=u.map(function(y,L){var D=t[c+L];return D.length>y.length?D:y}),f.value=l.join(u)}else f.value=l.join(e.slice(d,d+f.count));d+=f.count,f.added||(c+=f.count)}}var h=n[a-1];return a>1&&typeof h.value=="string"&&(h.added||h.removed)&&l.equals("",h.value)&&(n[a-2].value+=h.value,n.pop()),n}var ae=new E;function S(l,r,e){return ae.diff(l,r,e)}var q=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,U=/\S/,J=new E;J.equals=function(l,r){return this.options.ignoreCase&&(l=l.toLowerCase(),r=r.toLowerCase()),l===r||this.options.ignoreWhitespace&&!U.test(l)&&!U.test(r)};J.tokenize=function(l){for(var r=l.split(/([^\S\r\n]+|[()[\]{}'"\r\n]|\b)/),e=0;e<r.length-1;e++)!r[e+1]&&r[e+2]&&q.test(r[e])&&q.test(r[e+2])&&(r[e]+=r[e+2],r.splice(e+1,2),e--);return r};var j=new E;j.tokenize=function(l){this.options.stripTrailingCr&&(l=l.replace(/\r\n/g,`
`));var r=[],e=l.split(/(\n|\r\n)/);e[e.length-1]||e.pop();for(var t=0;t<e.length;t++){var i=e[t];t%2&&!this.options.newlineIsToken?r[r.length-1]+=i:(this.options.ignoreWhitespace&&(i=i.trim()),r.push(i))}return r};var de=new E;de.tokenize=function(l){return l.split(/(\S.+?[.!?])(?=\s+|$)/)};var fe=new E;fe.tokenize=function(l){return l.split(/([{}:;,]|\s+)/)};function O(l){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?O=function(r){return typeof r}:O=function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},O(l)}var ce=Object.prototype.toString,C=new E;C.useLongestToken=!0;C.tokenize=j.tokenize;C.castInput=function(l){var r=this.options,e=r.undefinedReplacement,t=r.stringifyReplacer,i=t===void 0?function(n,o){return typeof o=="undefined"?e:o}:t;return typeof l=="string"?l:JSON.stringify(P(l,null,null,i),i,"  ")};C.equals=function(l,r){return E.prototype.equals.call(C,l.replace(/,([\r\n])/g,"$1"),r.replace(/,([\r\n])/g,"$1"))};function P(l,r,e,t,i){r=r||[],e=e||[],t&&(l=t(i,l));var n;for(n=0;n<r.length;n+=1)if(r[n]===l)return e[n];var o;if(ce.call(l)==="[object Array]"){for(r.push(l),o=new Array(l.length),e.push(o),n=0;n<l.length;n+=1)o[n]=P(l[n],r,e,t,i);return r.pop(),e.pop(),o}if(l&&l.toJSON&&(l=l.toJSON()),O(l)==="object"&&l!==null){r.push(l),o={},e.push(o);var s=[],a;for(a in l)l.hasOwnProperty(a)&&s.push(a);for(s.sort(),n=0;n<s.length;n+=1)a=s[n],o[a]=P(l[a],r,e,t,a);r.pop(),e.pop()}else o=l;return o}var N=new E;N.tokenize=function(l){return l.slice()};N.join=N.removeEmpty=function(l){return l};function G(l,r){if(r<=0)return 1;let e=r-1,t=l.lastIndexOf(`
`,e-1)+1;return l.substring(t,e).trim().length===0?2:1}function Z(l,r,e){if(e<=0||l.length===0||r<=0||r>l.length)return"";let t=l[r-1],i=l.indexOf(`
`,r);if(t!==`
`&&(i!==-1&&r<i||i===-1&&r<l.length))return"";let o=0;for(let a=r-1;a>=0&&l[a]===`
`;a-=1)o+=1;let s=Math.max(0,e-o);return`
`.repeat(s)}function X(l,r){let e={};return l.forEach((t,i)=>{if(i<r.length){let n=r[i];if(t===n){e[i]="unchanged";return}S(t,n).some(a=>a.added||a.removed)?n.trim()!==""?e[i]="modified":e[i]="removed":e[i]="unchanged";return}e[i]="removed"}),e}function Q(l,r){let e={};return r.forEach((t,i)=>{if(i<l.length){let n=l[i];if(t===n){e[i]="unchanged";return}if(n.trim()===""&&t.trim()!==""){e[i]="added";return}S(n,t).some(a=>a.added||a.removed)&&n.trim()===""?e[i]="added":e[i]="unchanged";return}e[i]="added"}),e}var F=class extends v.Modal{constructor(e,t){super(e);this.originalEditor=null;this.modifiedEditor=null;this.finalEditor=null;this.finalEditorMirrorEl=null;this.finalEditorMirrorScrollEl=null;this.finalEditorMirrorContentEl=null;this.boundSyncFinalEditorMirror=null;this.boundSyncFinalEditorMirrorFocusIn=null;this.boundSyncFinalEditorMirrorFocusOut=null;this.leftHoverState="default";this.rightHoverState="default";this.leftDiffOverlay=null;this.rightDiffOverlay=null;this.leftDiffContent=null;this.rightDiffContent=null;this.copyFlashTimer=null;this.leftPanel=null;this.middlePanel=null;this.rightPanel=null;this.isPointerInSidePanels=!1;this.isEditModeEnabled=!1;this.toggleEditModeBtn=null;this.boundHandleKeyDown=null;this.fontDisplayEl=null;this.isSyncingScroll=!1;this.leftTextareaScrollListener=null;this.rightTextareaScrollListener=null;this.leftOverlayScrollListener=null;this.rightOverlayScrollListener=null;this.history=[];this.historyIndex=0;this.isComposing=!1;this.preCompositionText="";this.finalEditorFlashRange=null;this.boundFinalEditorBeforeInput=null;this.originalText=t.originalText,this.modifiedText=t.modifiedText,this.onApply=t.onApply,this.fontSize=t.fontSize||14,this.plugin=t.plugin}onOpen(){this.titleEl.setText("Diff Apply"),this.modalEl.addClass("hybrid-diff-modal"),this.modalEl.style.setProperty("--hybrid-font-size",`${this.fontSize}px`),this.applyDiffThemeSettings();let e=this.contentEl.createDiv({cls:"hybrid-diff-container"}),t=e.createDiv({cls:"hybrid-editors-container"});this.createPanels(t),this.addHybridActions(e),this.addKeyboardShortcuts()}applyDiffThemeSettings(){let{defaultDiffStyle:e,completeDiffStyle:t,diffAddedColor:i,diffDeletedColor:n,diffDefaultOpacity:o,diffCompleteOpacity:s}=this.plugin.settings;this.modalEl.dataset.defaultStyle=e,this.modalEl.dataset.completeStyle=t,this.modalEl.style.setProperty("--hybrid-diff-added",i),this.modalEl.style.setProperty("--hybrid-diff-deleted",n);let a=this.normalizeOpacity(o),d=this.normalizeOpacity(s);this.modalEl.style.setProperty("--hybrid-diff-added-bg",this.resolveRgba(i,a)),this.modalEl.style.setProperty("--hybrid-diff-deleted-bg",this.resolveRgba(n,a)),this.modalEl.style.setProperty("--hybrid-diff-added-bg-strong",this.resolveRgba(i,d)),this.modalEl.style.setProperty("--hybrid-diff-deleted-bg-strong",this.resolveRgba(n,d))}computeLineDiff(e,t){return X(e,t)}computeModifiedLineDiff(e,t){return Q(e,t)}createPanels(e){this.leftPanel=e.createDiv({cls:"hybrid-panel original"}),this.leftPanel.createDiv({cls:"panel-header"}).setText(this.plugin.t("modal.header.original"));let i=this.leftPanel.createDiv({cls:"panel-content"}),n=this.createReadOnlyEditor(i,this.originalText,!0);n.addClass("diff-active"),this.originalEditor=n;let o=this.createInlineDiffOverlay(i);this.leftDiffOverlay=o.overlay,this.leftDiffContent=o.content,n.addEventListener("scroll",()=>{this.leftDiffContent&&(this.leftDiffContent.style.transform=`translate(-${n.scrollLeft}px, -${n.scrollTop}px)`)}),this.middlePanel=e.createDiv({cls:"hybrid-panel editable"}),this.middlePanel.createDiv({cls:"panel-header"}).setText(this.plugin.t("modal.header.editor"));let a=this.middlePanel.createDiv({cls:"panel-content"}),d=this.createEditableEditor(a,"");this.finalEditor=d,this.setupFinalEditorMirror(a),this.rightPanel=e.createDiv({cls:"hybrid-panel modified"}),this.rightPanel.createDiv({cls:"panel-header"}).setText(this.plugin.t("modal.header.modified"));let f=this.rightPanel.createDiv({cls:"panel-content"}),u=this.createReadOnlyEditor(f,this.modifiedText,!1);u.addClass("diff-active"),this.modifiedEditor=u;let p=this.createInlineDiffOverlay(f);this.rightDiffOverlay=p.overlay,this.rightDiffContent=p.content,u.addEventListener("scroll",()=>{this.rightDiffContent&&(this.rightDiffContent.style.transform=`translate(-${u.scrollLeft}px, -${u.scrollTop}px)`)});let h=y=>{this.isPointerInSidePanels=y,this.syncFinalEditorMirror()};this.leftPanel.addEventListener("pointerenter",()=>h(!0)),this.leftPanel.addEventListener("pointerleave",()=>h(!1)),this.rightPanel.addEventListener("pointerenter",()=>h(!0)),this.rightPanel.addEventListener("pointerleave",()=>h(!1)),this.setupDiffHoverListeners(),this.leftDiffContent&&this.renderDefaultDiffMarks(this.leftDiffContent,this.originalText,!0),this.rightDiffContent&&this.renderDefaultDiffMarks(this.rightDiffContent,this.modifiedText,!1)}setupFinalEditorMirror(e){if(!this.finalEditor)return;let t=e.createDiv({cls:"diff-apply-editor-mirror"}),i=t.createDiv({cls:"diff-apply-editor-mirror-scroll"}),n=i.createDiv({cls:"diff-apply-editor-mirror-content"});this.finalEditorMirrorEl=t,this.finalEditorMirrorScrollEl=i,this.finalEditorMirrorContentEl=n,this.syncFinalEditorMirrorStyles();let o=()=>this.syncFinalEditorMirror();this.boundSyncFinalEditorMirror=o,this.finalEditor.addEventListener("input",o),this.finalEditor.addEventListener("select",o),this.finalEditor.addEventListener("keyup",o),this.finalEditor.addEventListener("mouseup",o),this.finalEditor.addEventListener("scroll",o),this.boundFinalEditorBeforeInput=()=>this.cancelFinalEditorFlashSelection(),this.finalEditor.addEventListener("beforeinput",this.boundFinalEditorBeforeInput,!0),this.boundSyncFinalEditorMirrorFocusIn=()=>o(),this.boundSyncFinalEditorMirrorFocusOut=()=>window.setTimeout(o,0),this.modalEl.addEventListener("focusin",this.boundSyncFinalEditorMirrorFocusIn,{capture:!0}),this.modalEl.addEventListener("focusout",this.boundSyncFinalEditorMirrorFocusOut,{capture:!0}),this.syncFinalEditorMirror()}cancelFinalEditorFlashSelection(){if(!this.finalEditorFlashRange||!this.finalEditor)return;let{start:e,end:t}=this.finalEditorFlashRange;this.finalEditor.selectionStart===e&&this.finalEditor.selectionEnd===t&&this.finalEditor.setSelectionRange(t,t),this.finalEditorFlashRange=null,this.copyFlashTimer&&(clearTimeout(this.copyFlashTimer),this.copyFlashTimer=null)}syncFinalEditorMirrorStyles(){if(!this.finalEditor||!this.finalEditorMirrorEl||!this.finalEditorMirrorScrollEl)return;let e=window.getComputedStyle(this.finalEditor);this.finalEditorMirrorEl.style.position="absolute",this.finalEditorMirrorEl.style.top="0",this.finalEditorMirrorEl.style.left="0",this.finalEditorMirrorEl.style.right="0",this.finalEditorMirrorEl.style.bottom="0",this.finalEditorMirrorEl.style.pointerEvents="none",this.finalEditorMirrorEl.style.zIndex="2",this.finalEditorMirrorEl.style.display="none",this.finalEditorMirrorScrollEl.style.width="100%",this.finalEditorMirrorScrollEl.style.height="100%",this.finalEditorMirrorScrollEl.style.overflow="auto",this.finalEditorMirrorScrollEl.style.boxSizing=e.boxSizing,this.finalEditorMirrorScrollEl.style.padding=e.padding,this.finalEditorMirrorScrollEl.style.fontFamily=e.fontFamily,this.finalEditorMirrorScrollEl.style.fontSize=e.fontSize,this.finalEditorMirrorScrollEl.style.lineHeight=e.lineHeight,this.finalEditorMirrorScrollEl.style.letterSpacing=e.letterSpacing,this.finalEditorMirrorScrollEl.style.backgroundColor=e.backgroundColor,this.finalEditorMirrorScrollEl.style.color=e.color,this.finalEditorMirrorScrollEl.style.whiteSpace="pre-wrap",this.finalEditorMirrorScrollEl.style.wordBreak="break-word"}syncFinalEditorMirror(){var s,a,d;if(!this.finalEditor||!this.finalEditorMirrorEl||!this.finalEditorMirrorScrollEl||!this.finalEditorMirrorContentEl)return;let e=document.activeElement;if(!(e===this.originalEditor||e===this.modifiedEditor||this.isPointerInSidePanels)){this.finalEditorMirrorEl.style.display="none";return}this.finalEditorMirrorScrollEl.scrollTop=this.finalEditor.scrollTop,this.finalEditorMirrorScrollEl.scrollLeft=this.finalEditor.scrollLeft;let i=(s=this.finalEditor.value)!=null?s:"",n=(a=this.finalEditor.selectionStart)!=null?a:0,o=(d=this.finalEditor.selectionEnd)!=null?d:0;if(document.activeElement===this.finalEditor){this.finalEditorMirrorEl.style.display="none";return}this.finalEditorMirrorEl.style.display="block",this.renderFinalEditorMirrorContent(i,n,o)}renderFinalEditorMirrorContent(e,t,i){if(!this.finalEditorMirrorContentEl)return;let n=this.finalEditorMirrorContentEl;n.textContent="";let o=Math.max(0,Math.min(t,e.length)),s=Math.max(0,Math.min(i,e.length)),a=Math.min(o,s),d=Math.max(o,s),c=document.createDocumentFragment(),f=e.slice(0,a),u=e.slice(d);if(f&&c.appendChild(document.createTextNode(f)),a!==d){let p=document.createElement("span");p.className="diff-apply-editor-mirror-selection",p.textContent=e.slice(a,d),c.appendChild(p)}else{let p=document.createElement("span");p.className="diff-apply-editor-mirror-caret",p.textContent="\u200B",c.appendChild(p)}u&&c.appendChild(document.createTextNode(u)),n.appendChild(c)}createReadOnlyEditor(e,t,i=!1){let n=e.createEl("textarea");n.addClass("hybrid-editor"),n.addClass("hybrid-editor--readonly"),n.addClass(i?"hybrid-editor--original":"hybrid-editor--modified"),n.value=t,n.readOnly=!0;let o=null;return n.addEventListener("input",()=>{this.isEditModeEnabled&&(o&&clearTimeout(o),o=setTimeout(()=>{this.updateAllDiffViews()},300))}),n.addEventListener("dblclick",s=>{if(this.isEditModeEnabled)return;s.preventDefault();let a=n.selectionStart,d=n.value.lastIndexOf(`
`,a-1)+1,c=n.value.indexOf(`
`,a);c===-1&&(c=n.value.length);let f=n.value.substring(d,c);if(f.trim()!==""){if(!this.finalEditor)return;let u=this.plugin.settings.smartDblClickInsertNewlines?G(n.value,d):0,h=Z(this.finalEditor.value,this.finalEditor.selectionStart,u)+f;this.insertAtCursor(this.finalEditor,h)}window.setTimeout(()=>{n.setSelectionRange(a,a)},0)}),i?this.originalEditor=n:this.modifiedEditor=n,n}createEditableEditor(e,t){let i=e.createEl("textarea");return i.addClass("hybrid-editor"),i.addClass("hybrid-editor--final"),i.value=t,this.history=[t],this.historyIndex=0,this.isComposing=!1,this.preCompositionText=t,i.addEventListener("compositionstart",()=>{this.isComposing=!0,this.preCompositionText=i.value}),i.addEventListener("compositionend",()=>{this.isComposing=!1,this.addToHistory(i.value)}),i.addEventListener("input",()=>{this.isComposing||this.addToHistory(i.value)}),i.addEventListener("keydown",n=>{(n.metaKey||n.ctrlKey)&&n.key==="z"&&!n.shiftKey&&(n.preventDefault(),this.isComposing?(i.value=this.preCompositionText,this.isComposing=!1,this.historyIndex=this.history.indexOf(this.preCompositionText),this.historyIndex===-1&&this.addToHistory(this.preCompositionText)):this.historyIndex>0&&(this.historyIndex--,i.value=this.history[this.historyIndex]),i.focus()),(n.metaKey||n.ctrlKey)&&(n.key==="y"||n.key==="z"&&n.shiftKey)&&(n.preventDefault(),this.historyIndex<this.history.length-1&&(this.historyIndex++,i.value=this.history[this.historyIndex],i.focus()))}),i}createInlineDiffOverlay(e){let t=e.createDiv({cls:"diff-inline-overlay"}),i=t.createDiv({cls:"diff-inline-content"});return{overlay:t,content:i}}renderDefaultDiffMarks(e,t,i){if(e)if(e.textContent="",i){let n=this.modifiedEditor?this.modifiedEditor.value:this.modifiedText;S(t,n).forEach(s=>{if(!s.added){let a=e.createSpan();a.textContent=s.value,s.removed&&a.addClass("diff-deleted-default")}})}else{let n=this.originalEditor?this.originalEditor.value:this.originalText;S(n,t).forEach(s=>{if(!s.removed){let a=e.createSpan();a.textContent=s.value,s.added&&a.addClass("diff-added-default")}})}}renderHoverDiffMarks(e,t,i){if(e)if(e.textContent="",i){let n=this.modifiedEditor?this.modifiedEditor.value:this.modifiedText;S(t,n).forEach(s=>{if(!s.added){let a=e.createSpan();a.textContent=s.value,s.removed&&a.addClass("diff-deleted-hover")}})}else{let n=this.originalEditor?this.originalEditor.value:this.originalText;S(n,t).forEach(s=>{if(!s.removed){let a=e.createSpan();a.textContent=s.value,s.added&&a.addClass("diff-added-hover")}})}}renderCompleteDiff(e,t,i){if(!e)return;e.textContent="",S(t,i).forEach(o=>{let s=e.createSpan();s.textContent=o.value,o.removed?s.addClass("diff-deleted-complete"):o.added&&s.addClass("diff-added-complete")})}setupDiffHoverListeners(){!this.leftPanel||!this.rightPanel||(this.leftPanel.addEventListener("mouseenter",()=>this.handleLeftPanelEnter()),this.leftPanel.addEventListener("mouseleave",()=>this.handleLeftPanelLeave()),this.rightPanel.addEventListener("mouseenter",()=>this.handleRightPanelEnter()),this.rightPanel.addEventListener("mouseleave",()=>this.handleRightPanelLeave()))}handleLeftPanelEnter(){this.leftHoverState="hovered";let e=this.originalEditor?this.originalEditor.value:this.originalText,t=this.modifiedEditor?this.modifiedEditor.value:this.modifiedText;this.leftDiffContent&&this.renderHoverDiffMarks(this.leftDiffContent,e,!0),this.rightDiffContent&&this.rightDiffOverlay&&(this.renderCompleteDiff(this.rightDiffContent,e,t),this.rightDiffOverlay.addClass("scrollable"),this.rightDiffContent.style.transform="none",this.originalEditor&&this.ensureScrollableSpace(this.originalEditor,this.rightDiffOverlay)),this.originalEditor&&this.rightDiffOverlay&&(this.leftTextareaScrollListener=()=>{this.rightDiffOverlay&&this.syncScrollByPercentage(this.originalEditor,this.rightDiffOverlay)},this.rightOverlayScrollListener=()=>{this.originalEditor&&this.syncScrollByPercentage(this.rightDiffOverlay,this.originalEditor)},this.originalEditor.addEventListener("scroll",this.leftTextareaScrollListener),this.rightDiffOverlay.addEventListener("scroll",this.rightOverlayScrollListener))}handleLeftPanelLeave(){this.leftHoverState="default";let e=this.originalEditor?this.originalEditor.value:this.originalText,t=this.modifiedEditor?this.modifiedEditor.value:this.modifiedText;this.leftDiffContent&&this.renderDefaultDiffMarks(this.leftDiffContent,e,!0),this.rightDiffContent&&this.rightDiffOverlay&&(this.renderDefaultDiffMarks(this.rightDiffContent,t,!1),this.rightDiffOverlay.removeClass("scrollable"),this.modifiedEditor&&(this.rightDiffContent.style.transform=`translate(-${this.modifiedEditor.scrollLeft}px, -${this.modifiedEditor.scrollTop}px)`)),this.originalEditor&&this.restoreScrollableSpace(this.originalEditor),this.leftTextareaScrollListener&&this.originalEditor&&(this.originalEditor.removeEventListener("scroll",this.leftTextareaScrollListener),this.leftTextareaScrollListener=null),this.rightOverlayScrollListener&&this.rightDiffOverlay&&(this.rightDiffOverlay.removeEventListener("scroll",this.rightOverlayScrollListener),this.rightOverlayScrollListener=null)}handleRightPanelEnter(){this.rightHoverState="hovered";let e=this.originalEditor?this.originalEditor.value:this.originalText,t=this.modifiedEditor?this.modifiedEditor.value:this.modifiedText;this.rightDiffContent&&this.renderHoverDiffMarks(this.rightDiffContent,t,!1),this.leftDiffContent&&this.leftDiffOverlay&&(this.renderCompleteDiff(this.leftDiffContent,e,t),this.leftDiffOverlay.addClass("scrollable"),this.leftDiffContent.style.transform="none",this.modifiedEditor&&this.ensureScrollableSpace(this.modifiedEditor,this.leftDiffOverlay)),this.modifiedEditor&&this.leftDiffOverlay&&(this.rightTextareaScrollListener=()=>{this.leftDiffOverlay&&this.syncScrollByPercentage(this.modifiedEditor,this.leftDiffOverlay)},this.leftOverlayScrollListener=()=>{this.modifiedEditor&&this.syncScrollByPercentage(this.leftDiffOverlay,this.modifiedEditor)},this.modifiedEditor.addEventListener("scroll",this.rightTextareaScrollListener),this.leftDiffOverlay.addEventListener("scroll",this.leftOverlayScrollListener))}handleRightPanelLeave(){this.rightHoverState="default";let e=this.originalEditor?this.originalEditor.value:this.originalText,t=this.modifiedEditor?this.modifiedEditor.value:this.modifiedText;this.rightDiffContent&&this.renderDefaultDiffMarks(this.rightDiffContent,t,!1),this.leftDiffContent&&this.leftDiffOverlay&&(this.renderDefaultDiffMarks(this.leftDiffContent,e,!0),this.leftDiffOverlay.removeClass("scrollable"),this.originalEditor&&(this.leftDiffContent.style.transform=`translate(-${this.originalEditor.scrollLeft}px, -${this.originalEditor.scrollTop}px)`)),this.modifiedEditor&&this.restoreScrollableSpace(this.modifiedEditor),this.rightTextareaScrollListener&&this.modifiedEditor&&(this.modifiedEditor.removeEventListener("scroll",this.rightTextareaScrollListener),this.rightTextareaScrollListener=null),this.leftOverlayScrollListener&&this.leftDiffOverlay&&(this.leftDiffOverlay.removeEventListener("scroll",this.leftOverlayScrollListener),this.leftOverlayScrollListener=null)}syncDiffOverlayScroll(e,t){!e||!t||(t.scrollTop=e.scrollTop,t.scrollLeft=e.scrollLeft)}syncScrollByPercentage(e,t){if(!(!e||!t||this.isSyncingScroll)){this.isSyncingScroll=!0;try{let i=e.scrollHeight-e.clientHeight,n=i>0?e.scrollTop/i:0,o=t.scrollHeight-t.clientHeight;t.scrollTop=o*n,t.scrollLeft=e.scrollLeft}finally{setTimeout(()=>{this.isSyncingScroll=!1},0)}}}ensureScrollableSpace(e,t){if(!e||!t)return;let i=e.scrollHeight-e.clientHeight,n=t.scrollHeight-t.clientHeight;if(n>i){let o=n-i,s=parseInt(window.getComputedStyle(e).paddingBottom)||0;e.style.paddingBottom=`${s+o}px`,e.dataset.originalPaddingBottom=s.toString()}}restoreScrollableSpace(e){e&&e.dataset.originalPaddingBottom!==void 0&&(e.style.paddingBottom=`${e.dataset.originalPaddingBottom}px`,delete e.dataset.originalPaddingBottom)}updateAllDiffViews(){let e=this.originalEditor?this.originalEditor.value:this.originalText,t=this.modifiedEditor?this.modifiedEditor.value:this.modifiedText;this.leftHoverState==="default"&&this.rightHoverState==="default"?(this.leftDiffContent&&this.renderDefaultDiffMarks(this.leftDiffContent,e,!0),this.rightDiffContent&&this.renderDefaultDiffMarks(this.rightDiffContent,t,!1)):this.leftHoverState==="hovered"?(this.leftDiffContent&&this.renderHoverDiffMarks(this.leftDiffContent,e,!0),this.rightDiffContent&&this.renderCompleteDiff(this.rightDiffContent,e,t)):this.rightHoverState==="hovered"&&(this.rightDiffContent&&this.renderHoverDiffMarks(this.rightDiffContent,t,!1),this.leftDiffContent&&this.renderCompleteDiff(this.leftDiffContent,e,t))}normalizeOpacity(e){let t=Number.isFinite(e)?e:0;return Math.min(1,Math.max(0,t/100))}resolveRgba(e,t){let i=this.hexToRgb(e);return i?`rgba(${i.r}, ${i.g}, ${i.b}, ${t})`:e}hexToRgb(e){let t=e.trim();if(!t.startsWith("#"))return null;let i=t.slice(1);if(i.length===3){let n=parseInt(i[0]+i[0],16),o=parseInt(i[1]+i[1],16),s=parseInt(i[2]+i[2],16);return{r:n,g:o,b:s}}if(i.length===6){let n=parseInt(i.slice(0,2),16),o=parseInt(i.slice(2,4),16),s=parseInt(i.slice(4,6),16);return{r:n,g:o,b:s}}return null}addToHistory(e){this.historyIndex<this.history.length-1&&(this.history=this.history.slice(0,this.historyIndex+1)),this.history.push(e),this.historyIndex++,this.history.length>100&&(this.history.shift(),this.historyIndex--)}addHybridActions(e){let t=e.createDiv({cls:"hybrid-actions"});this.toggleEditModeBtn=t.createEl("button",{text:this.plugin.t("modal.toggle.editMode"),cls:"hybrid-toggle-btn"}),this.toggleEditModeBtn.setAttribute("aria-pressed","false");let i=t.createEl("button",{text:this.plugin.t("modal.action.clear"),cls:"hybrid-clear-btn"}),n=t.createEl("button",{text:this.plugin.t("modal.action.apply"),cls:"mod-cta hybrid-apply-btn"}),o=t.createEl("button",{text:this.plugin.t("modal.action.cancel"),cls:"hybrid-cancel-btn"}),s=t.createDiv({cls:"hybrid-font-controls"}),a=s.createEl("span",{text:this.plugin.t("modal.fontSize.label"),cls:"hybrid-font-label"}),d=s.createEl("button",{text:"-",cls:"hybrid-font-btn"});d.setAttribute("aria-label",this.plugin.t("modal.fontSize.decreaseAriaLabel")),d.setAttribute("title",this.plugin.t("modal.fontSize.decreaseAriaLabel")),this.fontDisplayEl=s.createEl("span",{text:`${this.fontSize}px`,cls:"hybrid-font-display"});let c=s.createEl("button",{text:"+",cls:"hybrid-font-btn"});c.setAttribute("aria-label",this.plugin.t("modal.fontSize.increaseAriaLabel")),c.setAttribute("title",this.plugin.t("modal.fontSize.increaseAriaLabel")),this.toggleEditModeBtn.addEventListener("click",()=>{this.toggleEditMode()}),i.addEventListener("click",()=>{this.finalEditor&&(this.finalEditor.value="",this.finalEditor.dispatchEvent(new Event("input",{bubbles:!0})),this.syncFinalEditorMirror())}),n.addEventListener("click",()=>{this.finalEditor&&(this.onApply(this.finalEditor.value),this.close())}),o.addEventListener("click",()=>{this.close()}),d.addEventListener("click",()=>{let f=Math.max(10,this.fontSize-1);this.fontDisplayEl&&(this.fontDisplayEl.textContent=`${f}px`),this.updateFontSize(f),this.plugin&&(this.plugin.settings.fontSize=f,this.plugin.saveSettings())}),c.addEventListener("click",()=>{let f=Math.min(24,this.fontSize+1);this.fontDisplayEl&&(this.fontDisplayEl.textContent=`${f}px`),this.updateFontSize(f),this.plugin&&(this.plugin.settings.fontSize=f,this.plugin.saveSettings())})}copyFromOriginal(){if(!this.originalEditor||!this.finalEditor)return;let e=this.getSelectedText(this.originalEditor);e?this.insertAtCursor(this.finalEditor,e):new v.Notice(this.plugin.t("modal.notice.selectTextInOriginal"))}copyFromModified(){if(!this.modifiedEditor||!this.finalEditor)return;let e=this.getSelectedText(this.modifiedEditor);e?this.insertAtCursor(this.finalEditor,e):new v.Notice(this.plugin.t("modal.notice.selectTextInModified"))}copyAllModified(){if(!this.modifiedEditor||!this.finalEditor)return;let e=this.modifiedEditor.value;e?(this.finalEditor.value=e,new v.Notice(this.plugin.t("modal.notice.copied"))):new v.Notice(this.plugin.t("modal.notice.modifiedEmpty"))}getSelectedText(e){let t=e.selectionStart,i=e.selectionEnd;return t===i?"":e.value.substring(t,i)}insertAtCursor(e,t){if(e.tagName!=="TEXTAREA")return;let i=e.scrollTop,n=e.selectionStart,o=e.selectionEnd,s=e.value.substring(0,n),a=e.value.substring(o),d=n,c=n+t.length,f=s+t+a;e.value=f,e.focus(),this.flashCopiedRange(e,d,c),e.scrollTop=i;let u=new Event("input",{bubbles:!0});e.dispatchEvent(u),this.syncFinalEditorMirror()}flashCopiedRange(e,t,i){t!==i&&(e===this.finalEditor&&(this.finalEditorFlashRange={start:t,end:i}),e.setSelectionRange(t,i),this.copyFlashTimer&&clearTimeout(this.copyFlashTimer),this.copyFlashTimer=setTimeout(()=>{e.selectionStart===t&&e.selectionEnd===i&&e.setSelectionRange(i,i),e===this.finalEditor&&(this.finalEditorFlashRange=null)},600))}addKeyboardShortcuts(){this.boundHandleKeyDown||(this.boundHandleKeyDown=this.handleKeyDown.bind(this)),document.addEventListener("keydown",this.boundHandleKeyDown,{capture:!0})}handleKeyDown(e){let t=document.activeElement,i=t?this.modalEl.contains(t):!1,n=document.documentElement;if(!(!i&&t!==document.body&&t!==n&&t!==null)&&(e.key==="Enter"||e.key==="Return"||e.keyCode===13)){if(t===this.finalEditor||this.isEditModeEnabled)return;if(e.preventDefault(),t===this.originalEditor){(this.originalEditor?this.getSelectedText(this.originalEditor):"")?(this.copyFromOriginal(),this.originalEditor&&this.originalEditor.setSelectionRange(this.originalEditor.selectionEnd,this.originalEditor.selectionEnd)):new v.Notice(this.plugin.t("modal.notice.selectTextInOriginal"));return}if(t===this.modifiedEditor){(this.modifiedEditor?this.getSelectedText(this.modifiedEditor):"")?(this.copyFromModified(),this.modifiedEditor&&this.modifiedEditor.setSelectionRange(this.modifiedEditor.selectionEnd,this.modifiedEditor.selectionEnd)):new v.Notice(this.plugin.t("modal.notice.selectTextInModified"));return}}}onClose(){if(this.boundSyncFinalEditorMirror&&this.finalEditor){let e=this.boundSyncFinalEditorMirror;this.finalEditor.removeEventListener("input",e),this.finalEditor.removeEventListener("select",e),this.finalEditor.removeEventListener("keyup",e),this.finalEditor.removeEventListener("mouseup",e),this.finalEditor.removeEventListener("scroll",e),this.boundSyncFinalEditorMirror=null}this.boundFinalEditorBeforeInput&&this.finalEditor&&(this.finalEditor.removeEventListener("beforeinput",this.boundFinalEditorBeforeInput,!0),this.boundFinalEditorBeforeInput=null),this.boundSyncFinalEditorMirrorFocusIn&&(this.modalEl.removeEventListener("focusin",this.boundSyncFinalEditorMirrorFocusIn,!0),this.boundSyncFinalEditorMirrorFocusIn=null),this.boundSyncFinalEditorMirrorFocusOut&&(this.modalEl.removeEventListener("focusout",this.boundSyncFinalEditorMirrorFocusOut,!0),this.boundSyncFinalEditorMirrorFocusOut=null),this.boundHandleKeyDown&&(document.removeEventListener("keydown",this.boundHandleKeyDown,{capture:!0}),this.boundHandleKeyDown=null),this.copyFlashTimer&&(clearTimeout(this.copyFlashTimer),this.copyFlashTimer=null),this.leftDiffOverlay=null,this.rightDiffOverlay=null,this.leftDiffContent=null,this.rightDiffContent=null,this.contentEl.empty()}updateFontSize(e){this.fontSize=e,this.modalEl.style.setProperty("--hybrid-font-size",`${e}px`),this.syncFinalEditorMirrorStyles(),this.syncFinalEditorMirror(),this.fontDisplayEl&&(this.fontDisplayEl.textContent=`${e}px`),this.updateAllDiffViews()}toggleEditMode(){this.isEditModeEnabled=!this.isEditModeEnabled,this.toggleEditModeBtn&&(this.isEditModeEnabled?this.toggleEditModeBtn.textContent=this.plugin.t("modal.toggle.readOnly"):this.toggleEditModeBtn.textContent=this.plugin.t("modal.toggle.editMode"),this.toggleEditModeBtn.setAttribute("aria-pressed",this.isEditModeEnabled?"true":"false"),this.toggleEditModeBtn.classList.toggle("is-active",this.isEditModeEnabled)),this.modalEl.classList.toggle("is-edit-mode",this.isEditModeEnabled),this.originalEditor&&(this.originalEditor.readOnly=!this.isEditModeEnabled),this.modifiedEditor&&(this.modifiedEditor.readOnly=!this.isEditModeEnabled),new v.Notice(this.isEditModeEnabled?this.plugin.t("modal.notice.editMode"):this.plugin.t("modal.notice.readOnly")),this.updateAllDiffViews()}};var R={fontSize:14,smartDblClickInsertNewlines:!0,language:"auto",defaultDiffStyle:"background",completeDiffStyle:"background",diffAddedColor:"#2e7d32",diffDeletedColor:"#d32f2f",diffDefaultOpacity:18,diffCompleteOpacity:28};var H=class extends A.Plugin{constructor(){super(...arguments);this.settings=R}t(e){return V(e,this.settings.language)}async onload(){await this.loadSettings(),this.addSettingTab(new T(this.app,this)),this.addCommand({id:"diff-apply-hybrid",name:this.t("command.hybrid.name"),editorCallback:e=>this.openHybridDiffForSelection(e)}),this.registerEvent(this.app.workspace.on("editor-menu",(e,t)=>{let i=t.getSelection();i&&i.length>0&&e.addItem(n=>n.setTitle(this.t("menu.hybrid.title")).setIcon("edit").onClick(()=>this.openHybridDiffForSelection(t)))}))}onunload(){}async loadSettings(){this.settings=Object.assign({},R,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async openHybridDiffForSelection(e){let t=e.getSelection();if(!t||t.length===0){new A.Notice(this.t("notice.selectOriginalSegment"));return}let i="";try{i=await navigator.clipboard.readText()}catch(a){console.warn(this.t("notice.clipboardReadFailed"),a)}let n=e.getCursor("from"),o=e.getCursor("to");new F(this.app,{originalText:t,modifiedText:i,onApply:a=>{e.replaceRange(a,n,o)},fontSize:this.settings.fontSize,plugin:this}).open()}};
